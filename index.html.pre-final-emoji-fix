<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1e293b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Game Night">
  <meta name="description" content="Score keeper for Flip 7, Yahtzee, Phase 10, Farkle, and Gin Rummy">
  <title>Game Night Scorekeeper</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="./icon-192.png">
  <!-- Firebase SDK (v9 compat for easier migration) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <!-- Firebase Configuration (user must create this file) -->
  <script src="./firebase-config.js" onerror="console.log('[Firebase] Config not found - running in local-only mode')"></script>
  
  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    html, body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overscroll-behavior: none; }
    input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; }
    input[type="number"] { -moz-appearance: textfield; }
    .dice { font-family: "Segoe UI Symbol", "Apple Color Emoji", sans-serif; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .pulse { animation: pulse 2s infinite; }
    
    .app { min-height: 100vh; padding: 16px; }
    .container { max-width: 512px; margin: 0 auto; }
    .card { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
    .btn { border: none; border-radius: 12px; padding: 12px 24px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: rgba(255,255,255,0.2); color: white; }
    .btn-primary:hover:not(:disabled) { background: rgba(255,255,255,0.3); }
    .input { width: 100%; padding: 12px 16px; border: none; border-radius: 12px; background: rgba(255,255,255,0.2); color: white; font-size: 16px; outline: none; }
    .input::placeholder { color: rgba(255,255,255,0.5); }
    .input:focus { box-shadow: 0 0 0 2px rgba(255,255,255,0.5); }
    .input-score { width: 80px; text-align: center; font-weight: bold; font-size: 18px; }
    
    .bg-slate { background: linear-gradient(135deg, #0f172a 0%, #334155 100%); }
    .bg-emerald { background: linear-gradient(135deg, #064e3b 0%, #047857 100%); }
    .bg-red { background: linear-gradient(135deg, #7f1d1d 0%, #b91c1c 100%); }
    .bg-blue { background: linear-gradient(135deg, #1e3a8a 0%, #1d4ed8 100%); }
    .bg-purple { background: linear-gradient(135deg, #581c87 0%, #7c3aed 100%); }
    .bg-amber { background: linear-gradient(135deg, #78350f 0%, #d97706 100%); }
    
    .accent-emerald { background: #10b981; } .accent-emerald:hover { background: #34d399; }
    .accent-red { background: #ef4444; } .accent-red:hover { background: #f87171; }
    .accent-blue { background: #3b82f6; } .accent-blue:hover { background: #60a5fa; }
    .accent-purple { background: #8b5cf6; } .accent-purple:hover { background: #a78bfa; }
    .accent-amber { background: #f59e0b; } .accent-amber:hover { background: #fbbf24; }
    
    .text-white { color: white; }
    .text-light { color: rgba(255,255,255,0.7); }
    .text-lighter { color: rgba(255,255,255,0.85); }
    .text-emerald { color: #6ee7b7; }
    .text-red { color: #fca5a5; }
    .text-blue { color: #93c5fd; }
    .text-purple { color: #c4b5fd; }
    .text-amber { color: #fcd34d; }
    .text-green { color: #86efac; }
    
    .flex { display: flex; } .flex-col { flex-direction: column; } .flex-1 { flex: 1; }
    .items-center { align-items: center; } .justify-between { justify-content: space-between; } .justify-center { justify-content: center; }
    .gap-1 { gap: 4px; } .gap-2 { gap: 8px; } .gap-3 { gap: 12px; } .gap-4 { gap: 16px; }
    .grid { display: grid; } .grid-2 { grid-template-columns: repeat(2, 1fr); } .grid-3 { grid-template-columns: repeat(3, 1fr); }
    .text-center { text-align: center; } .text-left { text-align: left; }
    .w-full { width: 100%; } .overflow-x { overflow-x: auto; }
    
    .mb-1 { margin-bottom: 4px; } .mb-2 { margin-bottom: 8px; } .mb-3 { margin-bottom: 12px; }
    .mb-4 { margin-bottom: 16px; } .mb-6 { margin-bottom: 24px; } .mb-8 { margin-bottom: 32px; }
    .mt-2 { margin-top: 8px; } .mt-3 { margin-top: 12px; } .mt-4 { margin-top: 16px; }
    .pt-4 { padding-top: 16px; } .pt-8 { padding-top: 32px; } .pb-24 { padding-bottom: 96px; }
    
    .text-xs { font-size: 12px; } .text-sm { font-size: 14px; } .text-lg { font-size: 18px; }
    .text-xl { font-size: 20px; } .text-2xl { font-size: 24px; } .text-3xl { font-size: 30px; }
    .text-4xl { font-size: 36px; } .text-5xl { font-size: 48px; } .text-6xl { font-size: 60px; }
    .font-medium { font-weight: 500; } .font-semibold { font-weight: 600; } .font-bold { font-weight: 700; }
    
    .badge { display: inline-block; padding: 8px 16px; border-radius: 9999px; font-size: 14px; font-weight: 500; background: rgba(255,255,255,0.2); color: white; }
    .progress-bar { height: 6px; background: rgba(255,255,255,0.2); border-radius: 9999px; overflow: hidden; margin-top: 4px; }
    .progress-fill { height: 100%; border-radius: 9999px; transition: width 0.3s; background: #fbbf24; }
    .divider { border-top: 1px solid rgba(255,255,255,0.2); margin: 8px 0; padding-top: 8px; }
    
    .game-card { display: flex; align-items: center; justify-content: space-between; padding: 16px; border-radius: 16px; margin-bottom: 12px; }
    .game-card-btn { display: flex; align-items: center; gap: 16px; flex: 1; background: none; border: none; cursor: pointer; text-align: left; }
    .game-icon { font-size: 40px; }
    
    .player-item { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.1); border-radius: 12px; padding: 12px 16px; margin-bottom: 8px; }
    .remove-btn { background: none; border: none; color: #fca5a5; font-size: 18px; cursor: pointer; padding: 4px 8px; }
    
    .standing-item { border-radius: 12px; padding: 12px 16px; margin-bottom: 8px; background: rgba(255,255,255,0.1); }
    .standing-item.leader { background: rgba(245, 158, 11, 0.3); }
    .rank { font-size: 18px; font-weight: bold; width: 24px; }
    .rank.leader { color: #fcd34d; }
    
    .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
    .tab { flex: 1; padding: 12px; border-radius: 12px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); }
    .tab.active { background: rgba(255,255,255,0.3); color: white; }
    
    .category-btn { padding: 8px; border-radius: 12px; border: none; cursor: pointer; text-align: center; }
    .category-btn.available { background: rgba(255,255,255,0.2); color: white; }
    .category-btn.available:hover { background: rgba(255,255,255,0.3); }
    .category-btn.selected { background: #f59e0b; color: white; box-shadow: 0 0 0 2px #fcd34d; }
    .category-btn.used { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.5); cursor: pointer; }
    
    .phase-box { aspect-ratio: 1; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; }
    .phase-box.complete { background: #22c55e; color: white; }
    .phase-box.current { background: #f59e0b; color: white; }
    .phase-box.pending { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.4); }
    
    .history-table { width: 100%; font-size: 14px; border-collapse: collapse; }
    .history-table th, .history-table td { padding: 8px; }
    .history-table th { color: rgba(255,255,255,0.7); font-weight: 500; }
    .history-table td { color: white; }
    .history-table .editable { cursor: pointer; border-radius: 4px; padding: 4px 8px; display: inline-block; min-width: 30px; }
    .history-table .editable:hover { background: rgba(255,255,255,0.2); }
    .history-table .zero { color: rgba(255,255,255,0.5); }
    .history-table .farkle { color: #f87171; }
    
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 16px; }
    .modal { background: #1e293b; border-radius: 20px; padding: 24px; max-width: 400px; width: 100%; }
    .modal-title { font-size: 20px; font-weight: bold; color: white; margin-bottom: 12px; text-align: center; }
    .modal-text { color: rgba(255,255,255,0.8); text-align: center; margin-bottom: 20px; }
    .modal-buttons { display: flex; gap: 12px; }
    .modal-buttons .btn { flex: 1; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #f87171; }
    .btn-cancel { background: rgba(255,255,255,0.2); color: white; }
    
    .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; padding: 16px; background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 100%); }
    .bottom-bar .container { display: flex; gap: 12px; }
    
    .phase-item { display: flex; align-items: flex-start; gap: 12px; padding: 12px; border-radius: 12px; margin-bottom: 8px; }
    .phase-item.complete { background: rgba(34, 197, 94, 0.2); }
    .phase-item.current { background: rgba(245, 158, 11, 0.2); box-shadow: 0 0 0 2px #f59e0b; }
    .phase-item.pending { background: rgba(255,255,255,0.05); }
    .phase-num { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    .phase-num.complete { background: #22c55e; color: white; }
    .phase-num.current { background: #f59e0b; color: white; }
    .phase-num.pending { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.4); }
    
    .score-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px; }
    .score-highlight { background: rgba(34, 197, 94, 0.2); padding: 12px; border-radius: 12px; margin-bottom: 8px; }
    .score-warning { background: rgba(239, 68, 68, 0.2); padding: 12px; border-radius: 12px; }
    
    .player-select { background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 8px; padding: 4px 12px; font-size: 14px; }
    .player-select option { background: #1e293b; }
    
    .player-tabs { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; }
    .player-tab { padding: 8px 16px; border-radius: 12px; border: none; font-size: 14px; font-weight: 500; cursor: pointer; white-space: nowrap; background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); }
    .player-tab.active { background: rgba(255,255,255,0.3); color: white; }
    
    .current-player { background: rgba(245, 158, 11, 0.3); border-radius: 16px; padding: 12px; text-align: center; margin-bottom: 16px; }
    
    .score-entry { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .score-entry-name { flex: 1; color: white; }
    .score-entry-phase { font-size: 14px; color: rgba(255,255,255,0.7); margin-left: 8px; }
    
    .phase-toggle { width: 100%; padding: 8px; border-radius: 8px; border: none; font-size: 14px; font-weight: 500; cursor: pointer; }
    .phase-toggle.incomplete { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); }
    .phase-toggle.complete { background: #22c55e; color: white; }
    
    .rules-btn { background: rgba(255,255,255,0.1); border: none; color: rgba(255,255,255,0.6); padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; }
    .rules-btn:hover { background: rgba(255,255,255,0.2); color: white; }
    
    /* Tablet styles */
    .tablet-only { display: none; }
    
    @media (min-width: 768px) {
      .tablet-only { display: block; grid-column: span 2; }
      .container { max-width: 800px; }
      .game-cards-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
      .cribbage-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; }
      .cribbage-board-card { margin-bottom: 0; }
      .cribbage-points-grid { grid-template-columns: repeat(3, 1fr); }
      .card { padding: 24px; }
      .standings-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
      .history-table { font-size: 16px; }
      .btn { padding: 14px 20px; font-size: 16px; }
      .input { padding: 14px 16px; font-size: 16px; }
      .player-setup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    }
    
    /* Large tablet / landscape */
    @media (min-width: 1024px) {
      .container { max-width: 960px; }
      .game-cards-grid { grid-template-columns: repeat(3, 1fr); }
    }

    /* Group Management Styles */
    .group-selector {
      font-size: 14px;
      padding: 8px 12px;
      margin-bottom: 16px;
    }

    .group-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      margin-bottom: 8px;
    }

    .member-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.3);
      object-fit: cover;
    }

    .invite-code {
      font-family: monospace;
      font-size: 20px;
      font-weight: bold;
      letter-spacing: 2px;
      padding: 12px;
      background: rgba(255,255,255,0.2);
      border-radius: 8px;
      text-align: center;
      user-select: all;
    }

    .member-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .member-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(e => {});
    }
  </script>
  <script type="text/babel">
    // ============================================
    // Game Night Scorekeeper
    // Version 5.2.0 - Player Groups
    // ============================================
    const APP_VERSION = '5.2.0';
    
    // Firebase initialization (if configured)
    let firebaseApp = null;
    let firebaseAuth = null;
    let firebaseDb = null;
    let firebaseConfigured = false;
    
    try {
      if (window.FIREBASE_CONFIG && window.FIREBASE_CONFIGURED) {
        firebaseApp = firebase.initializeApp(window.FIREBASE_CONFIG);
        firebaseAuth = firebase.auth();
        firebaseDb = firebase.firestore();
        firebaseConfigured = true;
        console.log(`[Game Night v${APP_VERSION}] Firebase initialized`);
      } else {
        console.log(`[Game Night v${APP_VERSION}] Running in local-only mode`);
      }
    } catch (e) {
      console.log(`[Game Night v${APP_VERSION}] Firebase init error:`, e.message);
    }
    
    const { useState, useEffect } = React;

    // Load wins from localStorage
    const loadWins = () => {
      try {
        const saved = localStorage.getItem('gameNightWins');
        return saved ? JSON.parse(saved) : {};
      } catch (e) {
        return {};
      }
    };

    // Save wins to localStorage
    const saveWins = (data) => {
      try {
        localStorage.setItem('gameNightWins', JSON.stringify(data));
      } catch (e) {
        console.log('Could not save wins');
      }
    };

    // Load saved players from localStorage
    const loadSavedPlayers = () => {
      try {
        const saved = localStorage.getItem('gameNightPlayers');
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        return [];
      }
    };

    // Save players to localStorage
    const savePlayers = (players) => {
      try {
        localStorage.setItem('gameNightPlayers', JSON.stringify(players));
      } catch (e) {
        console.log('Could not save players');
      }
    };

    // Load selected group from localStorage
    const loadSelectedGroup = () => {
      try {
        return localStorage.getItem('selectedGroupId');
      } catch (e) {
        return null;
      }
    };

    // Save selected group to localStorage
    const saveSelectedGroup = (groupId) => {
      try {
        if (groupId) {
          localStorage.setItem('selectedGroupId', groupId);
        } else {
          localStorage.removeItem('selectedGroupId');
        }
      } catch (e) {
        console.log('[Groups] Could not save selected group');
      }
    };

    const GAMES = {
      flip7: { name: 'Flip 7', icon: 'ðŸƒ', color: 'emerald', targetScore: 200, highestWins: true, description: 'First to 200 wins', minPlayers: 2, maxPlayers: 8, hasTabs: false,
        rules: {
          overview: "Flip 7 is a push-your-luck card game. Each turn, decide whether to flip another card or stop. Get as close to 7 cards as possible without busting!",
          setup: "Shuffle the deck. Each player starts with no cards face up.",
          gameplay: [
            "On your turn, flip cards one at a time from the deck",
            "After each flip, decide: flip another or stop?",
            "If you reach 7 cards, you've made it! Stop and score.",
            "BUST if you flip a duplicate number Ã¢â‚¬â€ score 0!",
            "Example: If you have a 5 and flip another 5, you bust"
          ],
          scoring: [
            "Stop with 1-7 unique cards: Add up all card values",
            "Number cards (2-10): Face value",
            "Face cards (J, Q, K): 10 points each",
            "Aces: 1 or 11 (your choice)",
            "Bust (duplicate card): 0 points for the round"
          ],
          winning: "First player to reach 200 points wins! If multiple players pass 200 in the same round, highest score wins."
        }
      },
      yahtzee: { name: 'Yahtzee', icon: 'ðŸŽ²', color: 'red', targetScore: null, highestWins: true, description: '13 categories, highest wins', minPlayers: 1, maxPlayers: 6, hasTabs: true, tabLabels: { scorecard: 'ðŸ“ Scorecard', reference: 'ðŸ“Š Reference' },
        rules: {
          overview: "Roll 5 dice up to 3 times per turn to make the best scoring combination. Fill all 13 categories on your scorecard.",
          setup: "Each player gets a scorecard. Decide who goes first.",
          gameplay: [
            "Roll all 5 dice",
            "Set aside any dice you want to keep",
            "Roll remaining dice (up to 2 more times)",
            "After your rolls, choose ONE category to score",
            "Once a category is used, it's locked for the game",
            "You may score 0 in a category if needed"
          ],
          scoring: [
            "UPPER SECTION (Ones thru Sixes):",
            "  â€¢ Add only the dice showing that number",
            "  â€¢ Example: Three 4s = 12 points in Fours",
            "  â€¢ BONUS: Score 35 extra if upper total â‰¥ 63",
            "",
            "LOWER SECTION:",
            "  â€¢ 3 of a Kind: Sum of ALL dice (need 3 matching)",
            "  â€¢ 4 of a Kind: Sum of ALL dice (need 4 matching)",
            "  â€¢ Full House: 25 pts (3 of one + 2 of another)",
            "  â€¢ Small Straight: 30 pts (4 in sequence: 1-2-3-4, 2-3-4-5, or 3-4-5-6)",
            "  â€¢ Large Straight: 40 pts (5 in sequence: 1-2-3-4-5 or 2-3-4-5-6)",
            "  â€¢ YAHTZEE: 50 pts (all 5 dice the same)",
            "  â€¢ Chance: Sum of all dice (use for bad rolls)"
          ],
          winning: "After all 13 categories are filled, add up your total. Highest score wins!"
        }
      },
      phase10: { name: 'Phase 10', icon: 'ðŸ”Ÿ', color: 'blue', targetScore: null, highestWins: false, description: 'Complete 10 phases first', minPlayers: 2, maxPlayers: 6, hasTabs: true, tabLabels: { scorecard: 'ðŸ“ Score', reference: 'ðŸ“‹ Phases' },
        rules: {
          overview: "Race to complete 10 phases in order. Each phase requires a specific combination of cards. Cards left in your hand count as penalty points!",
          setup: "Deal 10 cards to each player. Place remaining cards face down as draw pile. Flip one card to start the discard pile.",
          gameplay: [
            "Draw one card (from draw pile OR discard pile)",
            "Try to lay down your current phase (if you have the cards)",
            "You can also 'hit' on others' laid phases (add matching cards)",
            "Discard one card to end your turn",
            "Round ends when someone goes out (no cards left)",
            "You MUST complete phases in order (1 â†â€™ 2 â†â€™ 3... â†â€™ 10)"
          ],
          scoring: [
            "PENALTY POINTS (cards left in hand):",
            "  â€¢ Cards 1-9: 5 points each",
            "  â€¢ Cards 10-12: 10 points each",
            "  â€¢ Skip cards: 15 points each",
            "  â€¢ Wild cards: 25 points each",
            "",
            "IMPORTANT:",
            "  â€¢ If you complete your phase, advance to next phase",
            "  â€¢ If you don't complete it, stay on same phase",
            "  â€¢ Points are BAD - you want the lowest score!"
          ],
          winning: "First player to complete Phase 10 wins! If tied, lowest total penalty points breaks the tie."
        }
      },
      farkle: { name: 'Farkle', icon: 'ðŸŽ¯', color: 'purple', targetScore: 10000, highestWins: true, description: 'First to 10,000 wins', minPlayers: 2, maxPlayers: 8, hasTabs: true, tabLabels: { scorecard: 'ðŸ“ Scorecard', reference: 'ðŸŽ² Scoring' },
        rules: {
          overview: "Roll 6 dice and set aside scoring combinations. Push your luck to build points, but FARKLE (no scoring dice) and lose it all!",
          setup: "Need 6 dice. Decide who goes first. Some versions require 500+ to 'get on the board' before banking.",
          gameplay: [
            "Roll all 6 dice",
            "Set aside at least one scoring die/combo",
            "Choose: BANK your points or ROLL remaining dice",
            "If you roll and NO dice score = FARKLE! Lose all turn points",
            "If ALL 6 dice score, pick them all up and keep rolling!",
            "Hot Dice: Score with all 6, roll all 6 again"
          ],
          scoring: [
            "SINGLE DICE:",
            "  â€¢ Each 1 = 100 points",
            "  â€¢ Each 5 = 50 points",
            "  â€¢ Single 2, 3, 4, 6 = nothing!",
            "",
            "THREE OF A KIND:",
            "  â€¢ Three 1s = 1,000 points",
            "  â€¢ Three 2s = 200 points",
            "  â€¢ Three 3s = 300 points",
            "  â€¢ Three 4s = 400 points",
            "  â€¢ Three 5s = 500 points",
            "  â€¢ Three 6s = 600 points",
            "",
            "FOUR+ OF A KIND:",
            "  â€¢ 4 of a kind = 2Ãƒâ€” the triple value",
            "  â€¢ 5 of a kind = 4Ãƒâ€” the triple value",
            "  â€¢ 6 of a kind = 8Ãƒâ€” the triple value",
            "",
            "SPECIAL COMBOS:",
            "  â€¢ Straight (1-2-3-4-5-6) = 1,500 points",
            "  â€¢ Three Pairs = 1,500 points",
            "  â€¢ Two Triplets = 2,500 points"
          ],
          winning: "First player to reach 10,000 points wins! Final round: others get one more turn to beat the leader."
        }
      },
      ginRummy: { name: 'Gin Rummy', icon: 'ðŸƒ', color: 'amber', targetScore: 100, highestWins: true, description: 'First to 100 wins', minPlayers: 2, maxPlayers: 4, hasTabs: false,
        rules: {
          overview: "Form melds (sets and runs) with your cards. Knock when your unmatched cards (deadwood) total 10 or less, or go GIN with no deadwood!",
          setup: "Deal 10 cards each. Place remaining cards face down as stock. Flip one card to start discard pile.",
          gameplay: [
            "Draw one card (from stock OR discard pile)",
            "Form melds in your hand:",
            "  â€¢ Sets: 3-4 cards of same rank (e.g., 7-7-7)",
            "  â€¢ Runs: 3+ consecutive same suit (e.g., 4Ã¢â„¢Â -5Ã¢â„¢Â -6Ã¢â„¢Â )",
            "Discard one card to end your turn",
            "KNOCK: End round when deadwood Ã¢â€°Â¤ 10",
            "GIN: Knock with 0 deadwood for bonus!"
          ],
          scoring: [
            "CARD VALUES (for deadwood):",
            "  â€¢ Face cards (J, Q, K): 10 points",
            "  â€¢ Aces: 1 point",
            "  â€¢ Number cards: Face value",
            "",
            "WINNING THE HAND:",
            "  â€¢ Knock: Score difference between deadwoods",
            "  â€¢ Gin Bonus: 25 points + opponent's deadwood",
            "  â€¢ Undercut: If defender has Ã¢â€°Â¤ knocker's deadwood,",
            "    defender scores 25 + the difference!",
            "",
            "BIG GIN: Go gin on 11 cards (before discarding) = 31 bonus"
          ],
          winning: "First player to reach 100 points wins the match!"
        }
      },
      cribbage: { name: 'Cribbage', icon: 'ðŸ›¤ï¸', color: 'emerald', targetScore: 121, highestWins: true, description: 'First to 121 wins', minPlayers: 2, maxPlayers: 2, hasTabs: true, tabLabels: { scorecard: 'ðŸ›¤ï¸ Board', reference: 'ðŸ“– Scoring' },
        rules: {
          overview: "A classic 2-player card game combining luck and strategy. Score points during play (pegging) and by making combinations in your hand. First to 121 wins!",
          setup: "Deal 6 cards each. Each player discards 2 cards face-down to the 'crib' (dealer's bonus hand). Cut deck to reveal 'starter' card.",
          gameplay: [
            "PEGGING: Take turns playing cards, keeping running total",
            "  â€¢ Can't exceed 31 Ã¢â‚¬â€ say 'Go' if you can't play",
            "  â€¢ Hit 31 exactly or last to play = points",
            "  â€¢ Reset to 0 and continue until cards gone",
            "THE SHOW: Count points in your hand + starter card",
            "  â€¢ Non-dealer counts first, then dealer",
            "  â€¢ Dealer also counts the crib",
            "Alternate dealing each round"
          ],
          scoring: [
            "PEGGING (during play):",
            "  â€¢ 15 exactly: 2 pts",
            "  â€¢ 31 exactly: 2 pts",
            "  â€¢ Pair: 2 pts",
            "  â€¢ Three of a kind: 6 pts",
            "  â€¢ Four of a kind: 12 pts",
            "  â€¢ Run (3+): 1 pt per card",
            "  â€¢ Go (opponent can't play): 1 pt",
            "  â€¢ Last card: 1 pt",
            "",
            "THE SHOW (hand counting):",
            "  â€¢ 15s: 2 pts per combo totaling 15",
            "  â€¢ Pairs: 2 pts each",
            "  â€¢ Runs: 1 pt per card in sequence",
            "  â€¢ Flush: 4 pts (5 if starter matches)",
            "  â€¢ Nobs: 1 pt (Jack matching starter suit)",
            "",
            "SPECIAL:",
            "  â€¢ His Heels: 2 pts if starter is a Jack (to dealer)"
          ],
          winning: "First to 121 wins! If winner hits 121 before loser reaches 91, it's a 'skunk' (double win)!"
        }
      },
      pitch: { name: 'Pitch', icon: 'â™ ï¸', color: 'purple', targetScore: 52, highestWins: true, description: '10-point or 13-point', minPlayers: 4, maxPlayers: 6, hasTabs: true, tabLabels: { scorecard: 'ðŸ“ Score', reference: 'ðŸ“– Points' },
        rules: {
          overview: "A trick-taking game where you bid on how many points you can take. Only trump cards are played. The bidder (pitcher) sets trump and tries to make their bid.",
          setup: "Deal 9 cards each (10-pt/13-pt). After bidding, discard non-trump and redraw to 6 cards. Pitcher gets remaining cards.",
          gameplay: [
            "Bid on points you expect to take (min 4-5)",
            "High bidder sets trump suit",
            "Discard non-trump, redraw to 6 cards",
            "Only trump cards can be played",
            "Highest trump wins each trick",
            "Play until all trump played or hands empty"
          ],
          scoring: [
            "10-POINT:",
            "  â€¢ Ace (High): 1 pt",
            "  â€¢ Jack: 1 pt",
            "  â€¢ Off-Jack (Jick): 1 pt",
            "  â€¢ High Joker: 1 pt",
            "  â€¢ Low Joker: 1 pt",
            "  â€¢ 10: 1 pt",
            "  â€¢ 3: 3 pts",
            "  â€¢ 2 (Low): 1 pt - goes to HOLDER",
            "",
            "13-POINT: Add Off-3 (3 pts)",
            "",
            "SHOOT THE MOON: Bid all points"
          ],
          winning: "First team to target score wins! Bidding team must make bid or goes set (loses bid amount)."
        }
      }
    };

    const PHASE10_PHASES = [
      { num: 1, name: "2 Sets of 3", example: "3-3-3 & 7-7-7" },
      { num: 2, name: "1 Set of 3 + 1 Run of 4", example: "5-5-5 & 2-3-4-5" },
      { num: 3, name: "1 Set of 4 + 1 Run of 4", example: "8-8-8-8 & 5-6-7-8" },
      { num: 4, name: "1 Run of 7", example: "2-3-4-5-6-7-8" },
      { num: 5, name: "1 Run of 8", example: "1-2-3-4-5-6-7-8" },
      { num: 6, name: "1 Run of 9", example: "2-3-4-5-6-7-8-9-10" },
      { num: 7, name: "2 Sets of 4", example: "4-4-4-4 & 9-9-9-9" },
      { num: 8, name: "7 Cards Same Color", example: "Any 7 blue cards" },
      { num: 9, name: "1 Set of 5 + 1 Set of 2", example: "6-6-6-6-6 & 3-3" },
      { num: 10, name: "1 Set of 5 + 1 Set of 3", example: "2-2-2-2-2 & 10-10-10" }
    ];

    const YAHTZEE_CATEGORIES = {
      upper: [
        { key: 'ones', name: 'Ones', icon: 'Ã¢Å¡â‚¬' }, { key: 'twos', name: 'Twos', icon: 'Ã¢Å¡Â' },
        { key: 'threes', name: 'Threes', icon: 'Ã¢Å¡â€š' }, { key: 'fours', name: 'Fours', icon: 'Ã¢Å¡Æ’' },
        { key: 'fives', name: 'Fives', icon: 'Ã¢Å¡â€ž' }, { key: 'sixes', name: 'Sixes', icon: 'Ã¢Å¡â€¦' },
      ],
      lower: [
        { key: 'threeKind', name: '3 of a Kind', icon: 'ðŸŽ²' }, { key: 'fourKind', name: '4 of a Kind', icon: 'ðŸŽ²' },
        { key: 'fullHouse', name: 'Full House', icon: 'Ã°Å¸ÂÂ ' }, { key: 'smallStraight', name: 'Sm Straight', icon: 'Ã°Å¸â€œË†' },
        { key: 'largeStraight', name: 'Lg Straight', icon: 'Ã°Å¸â€œË†' }, { key: 'yahtzee', name: 'YAHTZEE', icon: 'ðŸŒŸ' },
        { key: 'chance', name: 'Chance', icon: 'Ã¢Ââ€œ' },
      ]
    };

    function App() {
      const [screen, setScreen] = useState('home');
      const [selectedGame, setSelectedGame] = useState(null);
      const [players, setPlayers] = useState([]);
      const [newPlayerName, setNewPlayerName] = useState('');
      const [currentRound, setCurrentRound] = useState(1);
      const [roundScores, setRoundScores] = useState({});
      const [winner, setWinner] = useState(null);
      const [phaseAdvance, setPhaseAdvance] = useState({});
      const [activeTab, setActiveTab] = useState('scorecard');
      const [currentPlayerIndex, setCurrentPlayerIndex] = useState(0);
      const [scoreInput, setScoreInput] = useState('');
      const [selectedCategory, setSelectedCategory] = useState(null);
      const [showResetConfirm, setShowResetConfirm] = useState(false);
      const [showHomeConfirm, setShowHomeConfirm] = useState(false);
      const [editingScore, setEditingScore] = useState(null);
      const [editingRoundScore, setEditingRoundScore] = useState(null);
      const [editingYahtzee, setEditingYahtzee] = useState(null);
      const [editingCribbage, setEditingCribbage] = useState(null);
      const [cribbageRounds, setCribbageRounds] = useState([]); // History of completed rounds
      const [cribbageCurrentRound, setCribbageCurrentRound] = useState({
        phase: 'peg', // 'peg' or 'show'
        player1Peg: 0,
        player2Peg: 0,
        player1Show: 0,
        player2Show: 0,
        pegConfirmed: false,
        showConfirmed: false
      });
      const [showRules, setShowRules] = useState(false);
      
      // Pitch-specific state
      const [pitchConfig, setPitchConfig] = useState({
        pointSystem: 10,
        gameMode: 'teams', // 'teams', 'callPartner', 'cutthroat'
        targetScore: 52,
        customTarget: '',
        moonReward: 'fixed', // 'double', 'fixed', 'autoWin', 'goTo'
        moonRewardValue: 50, // points to add, or score to go to
        moonPenalty: 'fixed', // 'set', 'fixed', 'zero', 'loseGame'
        moonPenaltyValue: 20 // points to lose (positive number)
      });
      const [pitchHand, setPitchHand] = useState({
        dealerIndex: 0,
        bidderIndex: null,
        bidAmount: 0,
        isMoon: false,
        calledCard: '',
        partnerIndex: null, // null initially, -1 if card in deck (bidder vs table)
        pointsWon: undefined
      });
      const [pitchSetupDone, setPitchSetupDone] = useState(false);
      const [editingPitch, setEditingPitch] = useState(null); // {team: 1 or 2, value: ''} or {playerIndex: n, value: ''}
      const [winsData, setWinsData] = useState({});
      const [showLeaderboard, setShowLeaderboard] = useState(false);
      const [savedPlayersList, setSavedPlayersList] = useState([]);
      const [saveNewPlayer, setSaveNewPlayer] = useState(true);

      // Authentication state
      const [currentUser, setCurrentUser] = useState(null);
      const [authLoading, setAuthLoading] = useState(true);

      // Group Management state
      const [showGroupManager, setShowGroupManager] = useState(false);
      const [currentGroups, setCurrentGroups] = useState([]);
      const [selectedGroupId, setSelectedGroupId] = useState(null);
      const [activeGroupData, setActiveGroupData] = useState(null);
      const [groupMembers, setGroupMembers] = useState([]);
      const [createGroupName, setCreateGroupName] = useState('');
      const [joinGroupCode, setJoinGroupCode] = useState('');
      const [groupLoading, setGroupLoading] = useState(false);

      // Firebase Auth Observer - Listen for auth state changes
      useEffect(() => {
        if (!firebaseAuth) {
          setAuthLoading(false);
          return;
        }

        const unsubscribe = firebaseAuth.onAuthStateChanged(async (user) => {
          setCurrentUser(user);
          setAuthLoading(false);

          if (user) {
            // User signed in - create/update profile in Firestore
            try {
              const userRef = firebaseDb.collection('users').doc(user.uid);
              const userDoc = await userRef.get();

              if (!userDoc.exists) {
                // First time login - create profile
                await userRef.set({
                  displayName: user.displayName || 'Anonymous',
                  email: user.email,
                  photoURL: user.photoURL,
                  createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                  lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('[Auth] Created new user profile for:', user.displayName);
              } else {
                // Update last login
                await userRef.update({
                  lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('[Auth] Updated last login for:', user.displayName);
              }
            } catch (error) {
              console.error('[Auth] Error updating user profile:', error);
            }
          }
        });

        return () => unsubscribe();
      }, []);

      // Load wins and saved players on mount
      useEffect(() => {
        setWinsData(loadWins());
        setSavedPlayersList(loadSavedPlayers());
      }, []);

      // Track if we've recorded this win
      const [winRecorded, setWinRecorded] = useState(false);

      // Record win when game ends
      useEffect(() => {
        if (screen === 'winner' && winner && selectedGame && !winRecorded) {
          setWinRecorded(true);
          setWinsData(prevData => {
            const newData = { ...prevData };
            if (!newData[winner.name]) newData[winner.name] = {};
            if (!newData[winner.name][selectedGame]) newData[winner.name][selectedGame] = 0;
            newData[winner.name][selectedGame]++;
            saveWins(newData);
            return newData;
          });
        }
      }, [screen, winner, selectedGame, winRecorded]);

      // Reset winRecorded when leaving winner screen
      useEffect(() => {
        if (screen !== 'winner') {
          setWinRecorded(false);
        }
      }, [screen]);

      // Load selected group from localStorage
      useEffect(() => {
        const savedGroupId = loadSelectedGroup();
        if (savedGroupId && firebaseConfigured && currentUser) {
          setSelectedGroupId(savedGroupId);
        }
      }, [currentUser]);

      // Listen to user's groups (real-time updates)
      useEffect(() => {
        if (!firebaseDb || !currentUser) {
          setCurrentGroups([]);
          return;
        }

        // Query all groups where the user is a member
        // Note: We can't use array-contains with object, so we query all groups
        // and filter on client side, or use a memberIds array field
        const unsubscribe = firebaseDb.collection('groups')
          .onSnapshot(snapshot => {
            const allGroups = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));

            // Filter to groups where current user is a member
            const userGroups = allGroups.filter(group =>
              group.members && group.members.some(m => m.userId === currentUser.uid)
            );

            setCurrentGroups(userGroups);

            // Update active group data if it changed
            if (selectedGroupId) {
              const activeGroup = userGroups.find(g => g.id === selectedGroupId);
              if (activeGroup) {
                setActiveGroupData(activeGroup);
                setGroupMembers(activeGroup.members || []);
              } else {
                // Group was deleted or user was removed
                setSelectedGroupId(null);
                saveSelectedGroup(null);
                setActiveGroupData(null);
                setGroupMembers([]);
              }
            }
          }, error => {
            console.error('[Groups] Listener error:', error);
          });

        return () => unsubscribe();
      }, [currentUser, selectedGroupId]);

      // Record a win (for manual use if needed)
      const recordWin = (playerName, gameKey) => {
        setWinsData(prevData => {
          const newData = { ...prevData };
          if (!newData[playerName]) newData[playerName] = {};
          if (!newData[playerName][gameKey]) newData[playerName][gameKey] = 0;
          newData[playerName][gameKey]++;
          saveWins(newData);
          return newData;
        });
      };

      // Get total wins for a player
      const getTotalWins = (playerName) => {
        if (!winsData[playerName]) return 0;
        return Object.values(winsData[playerName]).reduce((a, b) => a + b, 0);
      };

      // Get all players sorted by total wins
      const getLeaderboard = () => {
        const players = Object.keys(winsData);
        return players.map(name => ({
          name,
          total: getTotalWins(name),
          games: winsData[name]
        })).sort((a, b) => b.total - a.total);
      };

      // Export wins data as CSV
      const exportData = () => {
        const gameKeys = Object.keys(GAMES);
        const headers = ['Player', ...gameKeys.map(k => GAMES[k].name), 'Total'];
        const rows = [headers.join(',')];
        
        Object.entries(winsData).forEach(([player, games]) => {
          const total = Object.values(games).reduce((a, b) => a + b, 0);
          const row = [
            player,
            ...gameKeys.map(k => games[k] || 0),
            total
          ];
          rows.push(row.join(','));
        });
        
        const csv = rows.join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'game-night-wins.csv';
        a.click();
        URL.revokeObjectURL(url);
      };

      // Import wins data (supports both CSV and JSON)
      const importData = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const text = e.target.result;
            let imported;
            
            if (file.name.endsWith('.json')) {
              imported = JSON.parse(text);
            } else {
              // Parse CSV
              const lines = text.trim().split('\n');
              const headers = lines[0].split(',');
              const gameKeys = Object.keys(GAMES);
              imported = {};
              
              for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const player = values[0];
                imported[player] = {};
                
                gameKeys.forEach((key, idx) => {
                  const wins = parseInt(values[idx + 1]) || 0;
                  if (wins > 0) imported[player][key] = wins;
                });
              }
            }
            
            setWinsData(imported);
            saveWins(imported);
            alert('Wins data imported successfully!');
          } catch (err) {
            alert('Error importing file. Check the format and try again.');
          }
        };
        reader.readAsText(file);
      };

      // Clear all wins
      const clearWins = () => {
        if (confirm('Clear ALL wins data? This cannot be undone!')) {
          setWinsData({});
          saveWins({});
        }
      };

      // Authentication functions
      const handleSignIn = async () => {
        if (!firebaseAuth) {
          alert('Firebase is not configured. Running in local-only mode.');
          return;
        }

        try {
          const provider = new firebase.auth.GoogleAuthProvider();
          await firebaseAuth.signInWithPopup(provider);
          console.log('[Auth] Sign-in successful');
        } catch (error) {
          console.error('[Auth] Sign-in error:', error);
          if (error.code !== 'auth/popup-closed-by-user') {
            alert('Sign-in failed: ' + error.message);
          }
        }
      };

      const handleSignOut = async () => {
        if (!firebaseAuth) return;

        try {
          await firebaseAuth.signOut();
          console.log('[Auth] Sign-out successful');
        } catch (error) {
          console.error('[Auth] Sign-out error:', error);
          alert('Sign-out failed: ' + error.message);
        }
      };

      // Group Management functions
      const generateInviteCode = async () => {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let attempts = 0;

        while (attempts < 10) {
          let code = '';
          for (let i = 0; i < 6; i++) {
            code += chars.charAt(Math.floor(Math.random() * chars.length));
          }

          // Check uniqueness
          const existing = await firebaseDb.collection('groups')
            .where('inviteCode', '==', code)
            .limit(1)
            .get();

          if (existing.empty) return code;
          attempts++;
        }

        throw new Error('Failed to generate unique invite code');
      };

      const handleCreateGroup = async () => {
        if (!firebaseDb || !currentUser) return;

        const name = createGroupName.trim();
        if (name.length < 3 || name.length > 30) {
          alert('Group name must be 3-30 characters');
          return;
        }

        setGroupLoading(true);

        try {
          const inviteCode = await generateInviteCode();
          const groupData = {
            name: name,
            ownerId: currentUser.uid,
            inviteCode: inviteCode,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            memberCount: 1,
            members: [{
              userId: currentUser.uid,
              displayName: currentUser.displayName || 'Anonymous',
              photoURL: currentUser.photoURL || '',
              joinedAt: firebase.firestore.FieldValue.serverTimestamp()
            }]
          };

          const groupRef = await firebaseDb.collection('groups').add(groupData);

          // Set as active group
          setSelectedGroupId(groupRef.id);
          saveSelectedGroup(groupRef.id);

          // Clear form
          setCreateGroupName('');

          console.log('[Groups] Created group:', groupRef.id);
        } catch (error) {
          console.error('[Groups] Create error:', error);
          alert('Failed to create group: ' + error.message);
        } finally {
          setGroupLoading(false);
        }
      };

      const handleJoinGroup = async () => {
        if (!firebaseDb || !currentUser) return;

        const code = joinGroupCode.trim().toUpperCase();
        if (code.length !== 6) {
          alert('Invite code must be 6 characters');
          return;
        }

        setGroupLoading(true);

        try {
          // Find group by invite code
          const groupsSnapshot = await firebaseDb.collection('groups')
            .where('inviteCode', '==', code)
            .limit(1)
            .get();

          if (groupsSnapshot.empty) {
            alert('Invalid invite code');
            return;
          }

          const groupDoc = groupsSnapshot.docs[0];
          const groupData = groupDoc.data();

          // Check if already a member
          const isMember = groupData.members.some(m => m.userId === currentUser.uid);
          if (isMember) {
            alert('You are already a member of this group');
            setSelectedGroupId(groupDoc.id);
            saveSelectedGroup(groupDoc.id);
            setJoinGroupCode('');
            return;
          }

          // Check member limit
          if (groupData.memberCount >= 20) {
            alert('Group is full (max 20 members)');
            return;
          }

          // Add member
          await firebaseDb.collection('groups').doc(groupDoc.id).update({
            members: firebase.firestore.FieldValue.arrayUnion({
              userId: currentUser.uid,
              displayName: currentUser.displayName || 'Anonymous',
              photoURL: currentUser.photoURL || '',
              joinedAt: firebase.firestore.FieldValue.serverTimestamp()
            }),
            memberCount: firebase.firestore.FieldValue.increment(1)
          });

          // Set as active group
          setSelectedGroupId(groupDoc.id);
          saveSelectedGroup(groupDoc.id);
          setJoinGroupCode('');

          console.log('[Groups] Joined group:', groupDoc.id);
        } catch (error) {
          console.error('[Groups] Join error:', error);
          alert('Failed to join group: ' + error.message);
        } finally {
          setGroupLoading(false);
        }
      };

      const switchToGroup = (groupId) => {
        if (!groupId) {
          setSelectedGroupId(null);
          saveSelectedGroup(null);
          setActiveGroupData(null);
          setGroupMembers([]);
          return;
        }

        setSelectedGroupId(groupId);
        saveSelectedGroup(groupId);

        const groupData = currentGroups.find(g => g.id === groupId);
        if (groupData) {
          setActiveGroupData(groupData);
          setGroupMembers(groupData.members || []);
        }
      };

      const handleLeaveGroup = async () => {
        if (!activeGroupData || !currentUser) return;

        if (!confirm(`Leave "${activeGroupData.name}"?`)) return;

        setGroupLoading(true);

        try {
          const groupRef = firebaseDb.collection('groups').doc(activeGroupData.id);
          const isOwner = activeGroupData.ownerId === currentUser.uid;

          // Remove self from members
          const updatedMembers = activeGroupData.members.filter(
            m => m.userId !== currentUser.uid
          );

          if (updatedMembers.length === 0) {
            // Last member - delete group
            await groupRef.delete();
            console.log('[Groups] Deleted empty group');
          } else if (isOwner) {
            // Transfer ownership to oldest member
            await groupRef.update({
              members: updatedMembers,
              memberCount: updatedMembers.length,
              ownerId: updatedMembers[0].userId
            });
            console.log('[Groups] Transferred ownership');
          } else {
            // Regular member leaving
            await groupRef.update({
              members: updatedMembers,
              memberCount: updatedMembers.length
            });
          }

          // Clear local selection
          setSelectedGroupId(null);
          saveSelectedGroup(null);
          setActiveGroupData(null);
          setGroupMembers([]);
          setShowGroupManager(false);

        } catch (error) {
          console.error('[Groups] Leave error:', error);
          alert('Failed to leave group: ' + error.message);
        } finally {
          setGroupLoading(false);
        }
      };

      const handleRemoveMember = async (userId) => {
        if (!activeGroupData || !currentUser) return;
        if (activeGroupData.ownerId !== currentUser.uid) {
          alert('Only the group owner can remove members');
          return;
        }

        const member = activeGroupData.members.find(m => m.userId === userId);
        if (!confirm(`Remove ${member.displayName} from group?`)) return;

        setGroupLoading(true);

        try {
          const updatedMembers = activeGroupData.members.filter(
            m => m.userId !== userId
          );

          await firebaseDb.collection('groups').doc(activeGroupData.id).update({
            members: updatedMembers,
            memberCount: updatedMembers.length
          });

          console.log('[Groups] Removed member');
        } catch (error) {
          console.error('[Groups] Remove error:', error);
          alert('Failed to remove member: ' + error.message);
        } finally {
          setGroupLoading(false);
        }
      };

      const copyToClipboard = (text) => {
        if (navigator.clipboard) {
          navigator.clipboard.writeText(text)
            .then(() => alert('Copied to clipboard!'))
            .catch(() => alert('Failed to copy'));
        } else {
          // Fallback for older browsers
          alert(`Invite Code: ${text}`);
        }
      };

      const game = selectedGame ? GAMES[selectedGame] : null;

      const selectGame = (gameKey) => { setSelectedGame(gameKey); setScreen('players'); setPlayers([]); setNewPlayerName(''); setSaveNewPlayer(true); };

      const addPlayer = () => {
        if (newPlayerName.trim() && players.length < (game?.maxPlayers || 8)) {
          const name = newPlayerName.trim();
          // Add to current game
          setPlayers([...players, {
            id: Date.now(), name, scores: [], total: 0,
            phase: selectedGame === 'phase10' ? 1 : null,
            yahtzeeScores: selectedGame === 'yahtzee' ? {} : null, yahtzeeBonus: 0
          }]);
          // Save to memory if checkbox is checked and not already saved
          if (saveNewPlayer && !savedPlayersList.includes(name)) {
            const updated = [...savedPlayersList, name].sort();
            setSavedPlayersList(updated);
            savePlayers(updated);
          }
          setNewPlayerName('');
        }
      };

      const addSavedPlayer = (name) => {
        if (players.length < (game?.maxPlayers || 8) && !players.find(p => p.name === name)) {
          setPlayers([...players, {
            id: Date.now(), name, scores: [], total: 0,
            phase: selectedGame === 'phase10' ? 1 : null,
            yahtzeeScores: selectedGame === 'yahtzee' ? {} : null, yahtzeeBonus: 0
          }]);
        }
      };

      const removeSavedPlayer = (name) => {
        const updated = savedPlayersList.filter(n => n !== name);
        setSavedPlayersList(updated);
        savePlayers(updated);
      };

      const removePlayer = (id) => setPlayers(players.filter(p => p.id !== id));

      const startGame = () => {
        if (players.length >= (game?.minPlayers || 2)) {
          setScreen('game'); setCurrentRound(1); setCurrentPlayerIndex(0); setActiveTab('scorecard');
          const init = {}; const initPhase = {};
          players.forEach(p => { init[p.id] = ''; initPhase[p.id] = false; });
          setRoundScores(init); setPhaseAdvance(initPhase);
        }
      };

      const handleScoreChange = (playerId, value) => {
        if (value === '' || value === '-' || /^-?\d*$/.test(value)) setRoundScores({ ...roundScores, [playerId]: value });
      };

      const togglePhaseAdvance = (playerId) => setPhaseAdvance({ ...phaseAdvance, [playerId]: !phaseAdvance[playerId] });

      const startEditScore = (playerId, roundIndex, currentValue) => setEditingScore({ playerId, roundIndex, value: currentValue.toString() });

      const saveEditScore = () => {
        if (!editingScore) return;
        const { playerId, roundIndex, value } = editingScore;
        const newScore = parseInt(value) || 0;
        setPlayers(players.map(p => {
          if (p.id === playerId) {
            const newScores = [...p.scores]; newScores[roundIndex] = newScore;
            return { ...p, scores: newScores, total: newScores.reduce((a, b) => a + b, 0) };
          }
          return p;
        }));
        setEditingScore(null);
      };

      const startEditYahtzee = (playerId, category, currentValue) => setEditingYahtzee({ playerId, category, value: currentValue.toString() });

      const saveEditYahtzee = () => {
        if (!editingYahtzee) return;
        const { playerId, category, value } = editingYahtzee;
        const newScore = parseInt(value) || 0;
        setPlayers(players.map(p => {
          if (p.id === playerId) {
            const newScores = { ...p.yahtzeeScores, [category]: newScore };
            const upperTotal = YAHTZEE_CATEGORIES.upper.reduce((sum, cat) => sum + (newScores[cat.key] || 0), 0);
            const bonus = upperTotal >= 63 ? 35 : 0;
            return { ...p, yahtzeeScores: newScores, yahtzeeBonus: bonus, total: Object.values(newScores).reduce((a, b) => a + b, 0) + bonus };
          }
          return p;
        }));
        setEditingYahtzee(null);
      };

      const submitYahtzeeScore = () => {
        if (selectedCategory === null || scoreInput === '') return;
        const score = parseInt(scoreInput) || 0;
        const currentPlayer = players[currentPlayerIndex];
        const updatedPlayers = players.map(p => {
          if (p.id === currentPlayer.id) {
            const newScores = { ...p.yahtzeeScores, [selectedCategory]: score };
            const upperTotal = YAHTZEE_CATEGORIES.upper.reduce((sum, cat) => sum + (newScores[cat.key] || 0), 0);
            const bonus = upperTotal >= 63 ? 35 : 0;
            return { ...p, yahtzeeScores: newScores, yahtzeeBonus: bonus, total: Object.values(newScores).reduce((a, b) => a + b, 0) + bonus };
          }
          return p;
        });
        setPlayers(updatedPlayers); setScoreInput(''); setSelectedCategory(null);
        if (currentPlayerIndex < players.length - 1) { setCurrentPlayerIndex(currentPlayerIndex + 1); }
        else {
          if (updatedPlayers.every(p => Object.keys(p.yahtzeeScores).length >= 13)) {
            setWinner(updatedPlayers.reduce((a, b) => a.total > b.total ? a : b)); setScreen('winner');
          } else { setCurrentPlayerIndex(0); setCurrentRound(currentRound + 1); }
        }
      };

      const submitRound = () => {
        if (!players.every(p => roundScores[p.id] !== '' && roundScores[p.id] !== '-')) return;
        const updatedPlayers = players.map(p => {
          const roundScore = parseInt(roundScores[p.id]) || 0;
          let newPhase = p.phase;
          if (selectedGame === 'phase10' && phaseAdvance[p.id] && p.phase <= 10) newPhase = p.phase + 1;
          return { ...p, scores: [...p.scores, roundScore], total: p.total + roundScore, phase: newPhase };
        });
        setPlayers(updatedPlayers);
        let gameWinner = null;
        if (selectedGame === 'phase10') {
          const winners = updatedPlayers.filter(p => p.phase > 10);
          if (winners.length > 0) gameWinner = winners.reduce((a, b) => a.total < b.total ? a : b);
        } else if (game?.targetScore) {
          const qualified = updatedPlayers.filter(p => p.total >= game.targetScore);
          if (qualified.length > 0) gameWinner = game.highestWins ? qualified.reduce((a, b) => a.total > b.total ? a : b) : qualified.reduce((a, b) => a.total < b.total ? a : b);
        }
        if (gameWinner) { setWinner(gameWinner); setScreen('winner'); }
        else {
          setCurrentRound(currentRound + 1);
          const init = {}; const initPhase = {};
          players.forEach(p => { init[p.id] = ''; initPhase[p.id] = false; });
          setRoundScores(init); setPhaseAdvance(initPhase);
        }
      };

      const confirmReset = () => {
        setPlayers(players.map(p => ({
          ...p, scores: [], total: 0, phase: selectedGame === 'phase10' ? 1 : null,
          yahtzeeScores: selectedGame === 'yahtzee' ? {} : null, yahtzeeBonus: 0
        })));
        setCurrentRound(1); setCurrentPlayerIndex(0); setActiveTab('scorecard'); setScreen('game'); setWinner(null);
        const init = {}; const initPhase = {};
        players.forEach(p => { init[p.id] = ''; initPhase[p.id] = false; });
        setRoundScores(init); setPhaseAdvance(initPhase); setSelectedCategory(null); setScoreInput(''); setShowResetConfirm(false); setEditingRoundScore(null);
      };

      const confirmGoHome = () => { setScreen('home'); setSelectedGame(null); setPlayers([]); setWinner(null); setShowResetConfirm(false); setShowHomeConfirm(false); setPitchSetupDone(false); setPitchHand({dealerIndex: 0, bidderIndex: null, bidAmount: 0, isMoon: false, calledCard: '', partnerIndex: null, pointsWon: undefined}); setEditingPitch(null); setEditingRoundScore(null); };
      const goHome = () => setShowHomeConfirm(true);

      const sortedPlayers = [...players].sort((a, b) => {
        if (selectedGame === 'phase10') { if (b.phase !== a.phase) return b.phase - a.phase; return a.total - b.total; }
        return game?.highestWins ? b.total - a.total : a.total - b.total;
      });

      const ResetConfirmModal = () => (
        <div className="modal-overlay">
          <div className="modal">
            <div className="modal-title">Ã¢Å¡Â Ã¯Â¸Â Reset Game?</div>
            <div className="modal-text">This will erase all scores and progress. This cannot be undone.</div>
            <div className="modal-buttons">
              <button className="btn btn-cancel" onClick={() => setShowResetConfirm(false)}>Cancel</button>
              <button className="btn btn-danger" onClick={confirmReset}>Reset</button>
            </div>
          </div>
        </div>
      );

      const HomeConfirmModal = () => (
        <div className="modal-overlay">
          <div className="modal">
            <div className="modal-title">Ã°Å¸ÂÂ  Leave Game?</div>
            <div className="modal-text">Your current game progress will be lost.</div>
            <div className="modal-buttons">
              <button className="btn btn-cancel" onClick={() => setShowHomeConfirm(false)}>Cancel</button>
              <button className="btn btn-danger" onClick={confirmGoHome}>Leave</button>
            </div>
          </div>
        </div>
      );

      const RoundScoreModal = () => {
        if (!editingRoundScore) return null;
        const player = players.find(p => p.id === editingRoundScore.playerId);
        const saveRoundScore = () => {
          const val = editingRoundScore.value;
          if (val === '' || val === '-' || /^-?\d*$/.test(val)) {
            setRoundScores({ ...roundScores, [editingRoundScore.playerId]: val });
          }
          setEditingRoundScore(null);
        };
        return (
          <div className="modal-overlay">
            <div className="modal">
              <div className="modal-title">Enter Score</div>
              <div className="modal-text">{player?.name}</div>
              <input type="text" inputMode="numeric" className="input text-center mb-4" style={{fontSize: '28px', padding: '16px'}}
                value={editingRoundScore.value} onChange={(e) => setEditingRoundScore({...editingRoundScore, value: e.target.value})} autoFocus 
                onKeyDown={(e) => e.key === 'Enter' && saveRoundScore()} />
              <div className="modal-buttons">
                <button className="btn btn-cancel" onClick={() => setEditingRoundScore(null)}>Cancel</button>
                <button className={`btn accent-${game?.color || 'amber'} text-white`} onClick={saveRoundScore}>OK</button>
              </div>
            </div>
          </div>
        );
      };

      const EditScoreModal = () => {
        if (!editingScore) return null;
        const player = players.find(p => p.id === editingScore.playerId);
        return (
          <div className="modal-overlay">
            <div className="modal">
              <div className="modal-title">Edit Score</div>
              <div className="modal-text">{player?.name} - Round {editingScore.roundIndex + 1}</div>
              <input type="text" inputMode="numeric" className="input text-center mb-4" style={{fontSize: '24px'}}
                value={editingScore.value} onChange={(e) => setEditingScore({...editingScore, value: e.target.value})} autoFocus />
              <div className="modal-buttons">
                <button className="btn btn-cancel" onClick={() => setEditingScore(null)}>Cancel</button>
                <button className="btn accent-amber text-white" onClick={saveEditScore}>Save</button>
              </div>
            </div>
          </div>
        );
      };

      const EditYahtzeeModal = () => {
        if (!editingYahtzee) return null;
        const player = players.find(p => p.id === editingYahtzee.playerId);
        const cat = [...YAHTZEE_CATEGORIES.upper, ...YAHTZEE_CATEGORIES.lower].find(c => c.key === editingYahtzee.category);
        return (
          <div className="modal-overlay">
            <div className="modal">
              <div className="modal-title">Edit Score</div>
              <div className="modal-text">{player?.name} - {cat?.name}</div>
              <input type="text" inputMode="numeric" className="input text-center mb-4" style={{fontSize: '24px'}}
                value={editingYahtzee.value} onChange={(e) => setEditingYahtzee({...editingYahtzee, value: e.target.value})} autoFocus />
              <div className="modal-buttons">
                <button className="btn btn-cancel" onClick={() => setEditingYahtzee(null)}>Cancel</button>
                <button className="btn accent-amber text-white" onClick={saveEditYahtzee}>Save</button>
              </div>
            </div>
          </div>
        );
      };

      const EditCribbageModal = () => {
        if (!editingCribbage) return null;

        // Handle round editing
        if (editingCribbage.type === 'round') {
          const round = cribbageRounds[editingCribbage.roundIndex];
          const saveRoundEdit = () => {
            const newP1Peg = Math.max(0, parseInt(editingCribbage.player1Peg) || 0);
            const newP2Peg = Math.max(0, parseInt(editingCribbage.player2Peg) || 0);
            const newP1Show = Math.max(0, parseInt(editingCribbage.player1Show) || 0);
            const newP2Show = Math.max(0, parseInt(editingCribbage.player2Show) || 0);

            // Recalculate totals from scratch
            let runningP1 = 0;
            let runningP2 = 0;
            const updatedRounds = cribbageRounds.map((r, i) => {
              if (i === editingCribbage.roundIndex) {
                runningP1 += newP1Peg + newP1Show;
                runningP2 += newP2Peg + newP2Show;
                return {
                  ...r,
                  player1Peg: newP1Peg,
                  player2Peg: newP2Peg,
                  player1Show: newP1Show,
                  player2Show: newP2Show,
                  total1: runningP1,
                  total2: runningP2
                };
              } else {
                runningP1 += r.player1Peg + r.player1Show;
                runningP2 += r.player2Peg + r.player2Show;
                return {...r, total1: runningP1, total2: runningP2};
              }
            });

            setCribbageRounds(updatedRounds);
            setPlayers(players.map((p, i) => ({
              ...p,
              total: i === 0 ? runningP1 : runningP2
            })));
            setEditingCribbage(null);
          };

          return (
            <div className="modal-overlay">
              <div className="modal">
                <div className="modal-title">Edit Round {round.roundNumber}</div>
                <div style={{marginBottom: '16px'}}>
                  <div style={{marginBottom: '12px'}}>
                    <div style={{color: '#fca5a5', fontSize: '13px', marginBottom: '4px'}}>ðŸ”´ {players[0]?.name}</div>
                    <div style={{display: 'flex', gap: '8px', marginBottom: '4px'}}>
                      <div style={{flex: 1}}>
                        <label style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)'}}>Peg</label>
                        <input type="text" inputMode="numeric" className="input text-center"
                          value={editingCribbage.player1Peg}
                          onChange={(e) => setEditingCribbage({...editingCribbage, player1Peg: e.target.value})} />
                      </div>
                      <div style={{flex: 1}}>
                        <label style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)'}}>Show</label>
                        <input type="text" inputMode="numeric" className="input text-center"
                          value={editingCribbage.player1Show}
                          onChange={(e) => setEditingCribbage({...editingCribbage, player1Show: e.target.value})} />
                      </div>
                    </div>
                  </div>
                  <div>
                    <div style={{color: '#93c5fd', fontSize: '13px', marginBottom: '4px'}}>ðŸ”µ {players[1]?.name}</div>
                    <div style={{display: 'flex', gap: '8px'}}>
                      <div style={{flex: 1}}>
                        <label style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)'}}>Peg</label>
                        <input type="text" inputMode="numeric" className="input text-center"
                          value={editingCribbage.player2Peg}
                          onChange={(e) => setEditingCribbage({...editingCribbage, player2Peg: e.target.value})} />
                      </div>
                      <div style={{flex: 1}}>
                        <label style={{fontSize: '11px', color: 'rgba(255,255,255,0.6)'}}>Show</label>
                        <input type="text" inputMode="numeric" className="input text-center"
                          value={editingCribbage.player2Show}
                          onChange={(e) => setEditingCribbage({...editingCribbage, player2Show: e.target.value})} />
                      </div>
                    </div>
                  </div>
                </div>
                <div className="modal-buttons">
                  <button className="btn btn-cancel" onClick={() => setEditingCribbage(null)}>Cancel</button>
                  <button className="btn accent-emerald text-white" onClick={saveRoundEdit}>Save</button>
                </div>
              </div>
            </div>
          );
        }

        // Handle legacy player total editing (not used in new UI, but keep for compatibility)
        const player = players[editingCribbage.playerIndex];
        const saveCribbageEdit = () => {
          const newTotal = Math.max(0, Math.min(121, parseInt(editingCribbage.value) || 0));
          if (newTotal >= 121) {
            setPlayers(players.map((p, i) => i === editingCribbage.playerIndex ? {...p, total: newTotal} : p));
            setWinner({...player, total: newTotal});
            setScreen('winner');
          } else {
            setPlayers(players.map((p, i) => i === editingCribbage.playerIndex ? {...p, total: newTotal} : p));
          }
          setEditingCribbage(null);
        };
        return (
          <div className="modal-overlay">
            <div className="modal">
              <div className="modal-title">Edit Score</div>
              <div className="modal-text">{player?.name}</div>
              <input type="text" inputMode="numeric" className="input text-center mb-4" style={{fontSize: '24px'}}
                value={editingCribbage.value} onChange={(e) => setEditingCribbage({...editingCribbage, value: e.target.value})} autoFocus />
              <div className="modal-buttons">
                <button className="btn btn-cancel" onClick={() => setEditingCribbage(null)}>Cancel</button>
                <button className="btn accent-emerald text-white" onClick={saveCribbageEdit}>Save</button>
              </div>
            </div>
          </div>
        );
      };

      const EditPitchModal = () => {
        if (!editingPitch) return null;
        const effectiveTarget = pitchConfig.customTarget ? parseInt(pitchConfig.customTarget) : pitchConfig.targetScore;
        
        const savePitchEdit = () => {
          const newTotal = parseInt(editingPitch.value) || 0;
          let newPlayers = [...players];
          
          if (editingPitch.team) {
            // Team mode - update player 0 for team 1, player 1 for team 2
            const playerIdx = editingPitch.team === 1 ? 0 : 1;
            newPlayers[playerIdx] = {...newPlayers[playerIdx], total: newTotal};
          } else if (editingPitch.playerIndex !== undefined) {
            // Individual mode
            newPlayers[editingPitch.playerIndex] = {...newPlayers[editingPitch.playerIndex], total: newTotal};
          }
          
          setPlayers(newPlayers);
          setEditingPitch(null);
          
          // Check for winner
          if (newTotal >= effectiveTarget) {
            const winnerPlayer = newPlayers.find(p => p.total >= effectiveTarget);
            if (winnerPlayer) {
              setWinner(winnerPlayer);
              setScreen('winner');
            }
          }
        };
        
        return (
          <div className="modal-overlay">
            <div className="modal">
              <div className="modal-title">Edit Score</div>
              <div className="modal-text">{editingPitch.team ? `Team ${editingPitch.team}` : players[editingPitch.playerIndex]?.name}</div>
              <input type="text" inputMode="numeric" className="input text-center mb-4" style={{fontSize: '24px'}}
                value={editingPitch.value} onChange={(e) => setEditingPitch({...editingPitch, value: e.target.value})} autoFocus />
              <div className="modal-buttons">
                <button className="btn btn-cancel" onClick={() => setEditingPitch(null)}>Cancel</button>
                <button className="btn accent-purple text-white" onClick={savePitchEdit}>Save</button>
              </div>
            </div>
          </div>
        );
      };

      // RULES SCREEN
      const RulesScreen = () => (
        <div className={`app bg-${game.color}`} style={{paddingBottom: '24px'}}>
          <div className="container">
            <button onClick={() => setShowRules(false)} className="text-white mb-4" style={{background: 'rgba(255,255,255,0.2)', padding: '8px 16px', borderRadius: '8px', border: 'none', cursor: 'pointer'}}>â†Â Back</button>
            <div className="text-center mb-6">
              <span className="text-5xl mb-2">{game.icon}</span>
              <h1 className="text-3xl font-bold text-white">{game.name} Rules</h1>
            </div>
            <div className="card">
              <h3 className="text-white font-semibold mb-2">Ã°Å¸â€œâ€“ Overview</h3>
              <p className="text-lighter">{game.rules.overview}</p>
            </div>
            <div className="card">
              <h3 className="text-white font-semibold mb-2">ðŸŽ´ Setup</h3>
              <p className="text-lighter">{game.rules.setup}</p>
            </div>
            <div className="card">
              <h3 className="text-white font-semibold mb-2">ðŸŽ® How to Play</h3>
              {(() => {
                let stepNum = 0;
                return game.rules.gameplay.map((step, i) => {
                  const isIndented = step.startsWith('  ');
                  if (!isIndented) stepNum++;
                  return (
                    <p key={i} className="text-lighter mb-1" style={{paddingLeft: isIndented ? '12px' : '0', fontSize: isIndented ? '14px' : '16px'}}>
                      {isIndented ? step : `${stepNum}. ${step}`}
                    </p>
                  );
                });
              })()}
            </div>
            <div className="card">
              <h3 className="text-white font-semibold mb-2">ðŸ§® Scoring</h3>
              {game.rules.scoring.map((rule, i) => {
                if (rule === '') return <div key={i} style={{height: '8px'}}></div>;
                const isHeader = rule.endsWith(':') && !rule.startsWith('  ');
                const isIndented = rule.startsWith('  ');
                return (
                  <p key={i} className={`mb-1 ${isHeader ? 'text-white font-medium mt-3' : 'text-lighter'}`} 
                     style={{paddingLeft: isIndented ? '12px' : '0', fontSize: isIndented ? '14px' : '16px'}}>
                    {rule}
                  </p>
                );
              })}
            </div>
            <div className="card">
              <h3 className="text-white font-semibold mb-2">Ã°Å¸Ââ€  Winning</h3>
              <p className="text-lighter">{game.rules.winning}</p>
            </div>
            <button onClick={() => setShowRules(false)} className={`btn accent-${game.color} text-white w-full mt-4`}>Got It!</button>
          </div>
        </div>
      );

      if (showRules && game) return <RulesScreen />;

      // GROUP MANAGER SCREEN
      const GroupManagerModal = () => (
        <div className="app bg-slate" style={{paddingBottom: '24px'}}>
          <div className="container">
            <button onClick={() => setShowGroupManager(false)} className="text-white mb-4" style={{background: 'rgba(255,255,255,0.2)', padding: '8px 16px', borderRadius: '8px', border: 'none', cursor: 'pointer'}}>â† Back</button>

            <div className="text-center mb-6">
              <span className="text-5xl mb-2">ðŸ‘¥</span>
              <h1 className="text-3xl font-bold text-white">Manage Groups</h1>
              <p className="text-light text-sm mt-1">Create and join game night groups</p>
            </div>

            {/* Active Group Section */}
            {activeGroupData && (
              <div className="card mb-4">
                <div className="flex justify-between items-center mb-3">
                  <h2 className="text-white font-semibold text-lg">{activeGroupData.name}</h2>
                  {activeGroupData.ownerId === currentUser.uid && (
                    <span className="badge text-xs" style={{background: 'rgba(245, 158, 11, 0.3)', color: '#fcd34d'}}>Owner</span>
                  )}
                </div>

                <div className="mb-3">
                  <p className="text-light text-sm mb-2">Invite Code:</p>
                  <div className="invite-code">{activeGroupData.inviteCode}</div>
                  <button onClick={() => copyToClipboard(activeGroupData.inviteCode)} className="btn btn-primary w-full mt-2 text-sm">
                    ðŸ“‹ Copy Code
                  </button>
                </div>

                <div className="divider"></div>

                <div className="mb-3">
                  <p className="text-light text-sm mb-2">Members ({groupMembers.length}):</p>
                  <div className="member-list">
                    {groupMembers.map(member => (
                      <div key={member.userId} className="member-item">
                        {member.photoURL ? (
                          <img src={member.photoURL} alt={member.displayName} className="member-avatar" />
                        ) : (
                          <div className="member-avatar" style={{background: 'rgba(255,255,255,0.2)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '14px'}}>
                            {member.displayName.charAt(0).toUpperCase()}
                          </div>
                        )}
                        <span className="text-white text-sm">{member.displayName}</span>
                        {activeGroupData.ownerId === currentUser.uid && member.userId !== currentUser.uid && (
                          <button onClick={() => handleRemoveMember(member.userId)} className="remove-btn" style={{fontSize: '14px', marginLeft: '4px'}}>âœ•</button>
                        )}
                      </div>
                    ))}
                  </div>
                </div>

                <button onClick={handleLeaveGroup} disabled={groupLoading} className="btn w-full text-sm" style={{background: 'rgba(239,68,68,0.3)', color: '#fca5a5'}}>
                  ðŸšª Leave Group
                </button>
              </div>
            )}

            {/* My Groups */}
            {currentGroups.length > 0 && (
              <div className="card mb-4">
                <h2 className="text-white font-semibold mb-3">My Groups</h2>
                {currentGroups.map(group => (
                  <div key={group.id} className="group-card">
                    <div>
                      <div className="text-white font-medium">{group.name}</div>
                      <div className="text-light text-xs">{group.memberCount} {group.memberCount === 1 ? 'member' : 'members'}</div>
                    </div>
                    <button
                      onClick={() => {
                        switchToGroup(group.id);
                        setShowGroupManager(false);
                      }}
                      className="btn btn-primary text-sm"
                      style={{padding: '6px 12px'}}
                      disabled={selectedGroupId === group.id}
                    >
                      {selectedGroupId === group.id ? 'Active' : 'Switch'}
                    </button>
                  </div>
                ))}
              </div>
            )}

            {/* Create Group Form */}
            <div className="card mb-4">
              <h2 className="text-white font-semibold mb-3">Create New Group</h2>
              <input
                type="text"
                value={createGroupName}
                onChange={(e) => setCreateGroupName(e.target.value)}
                placeholder="Enter group name (3-30 characters)"
                className="input mb-3"
                maxLength={30}
              />
              <button
                onClick={handleCreateGroup}
                disabled={groupLoading || createGroupName.trim().length < 3}
                className="btn accent-emerald text-white w-full"
              >
                {groupLoading ? 'Creating...' : 'âœ¨ Create Group'}
              </button>
            </div>

            {/* Join Group Form */}
            <div className="card">
              <h2 className="text-white font-semibold mb-3">Join with Code</h2>
              <input
                type="text"
                value={joinGroupCode}
                onChange={(e) => setJoinGroupCode(e.target.value.toUpperCase())}
                placeholder="Enter 6-character code"
                className="input mb-3"
                maxLength={6}
                style={{textTransform: 'uppercase', fontFamily: 'monospace', letterSpacing: '2px'}}
              />
              <button
                onClick={handleJoinGroup}
                disabled={groupLoading || joinGroupCode.length !== 6}
                className="btn accent-blue text-white w-full"
              >
                {groupLoading ? 'Joining...' : 'ðŸš€ Join Group'}
              </button>
            </div>

            <p className="text-center text-xs mt-4" style={{color: 'rgba(255,255,255,0.4)'}}>
              Groups sync across devices â€¢ Max 20 members per group
            </p>
          </div>
        </div>
      );

      if (showGroupManager) return <GroupManagerModal />;

      // LEADERBOARD SCREEN
      const LeaderboardScreen = () => {
        const leaderboard = getLeaderboard();
        const fileInputRef = React.useRef(null);
        
        return (
          <div className="app bg-slate" style={{paddingBottom: '24px'}}>
            <div className="container">
              <button onClick={() => setShowLeaderboard(false)} className="text-white mb-4" style={{background: 'rgba(255,255,255,0.2)', padding: '8px 16px', borderRadius: '8px', border: 'none', cursor: 'pointer'}}>â†Â Back</button>
              <div className="text-center mb-6">
                <span className="text-5xl mb-2">ðŸ†</span>
                <h1 className="text-3xl font-bold text-white">Wins Leaderboard</h1>
                <p className="text-light text-sm mt-1">Family bragging rights</p>
              </div>
              
              {leaderboard.length === 0 ? (
                <div className="card text-center">
                  <p className="text-light">No wins recorded yet!</p>
                  <p className="text-light text-sm mt-2">Play some games to see the leaderboard.</p>
                </div>
              ) : (
                <div className="card">
                  {leaderboard.map((player, i) => (
                    <div key={player.name} className={`standing-item ${i === 0 ? 'leader' : ''}`} style={{marginBottom: '12px'}}>
                      <div className="flex items-center justify-between mb-2">
                        <div className="flex items-center gap-3">
                          <span className={`rank ${i === 0 ? "leader" : ""}`} style={{fontSize: "24px"}}>{i === 0 ? "ðŸ¥‡" : i + 1}</span>
                          <span className="text-white font-bold text-lg">{player.name}</span>
                        </div>
                        <span className="text-white text-2xl font-bold">{player.total}</span>
                      </div>
                      <div className="flex gap-2 flex-wrap" style={{marginLeft: '36px'}}>
                        {Object.entries(player.games).map(([gameKey, wins]) => (
                          <span key={gameKey} className="text-xs" style={{background: 'rgba(255,255,255,0.1)', padding: '4px 8px', borderRadius: '6px', color: 'rgba(255,255,255,0.8)'}}>
                            {GAMES[gameKey]?.icon} {wins}
                          </span>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              )}

              <div className="card mt-4">
                <h3 className="text-white font-semibold mb-3">Ã°Å¸â€œÂ¦ Backup & Restore</h3>
                <p className="text-light text-sm mb-3">Export as CSV for Excel/Sheets, or restore from a backup file.</p>
                <div className="flex gap-2 mb-3">
                  <button onClick={exportData} className="btn btn-primary flex-1 text-sm">Ã¢Â¬â€¡Ã¯Â¸Â Export</button>
                  <button onClick={() => fileInputRef.current?.click()} className="btn btn-primary flex-1 text-sm">Ã¢Â¬â€ Ã¯Â¸Â Import</button>
                  <input ref={fileInputRef} type="file" accept=".csv,.json" onChange={importData} style={{display: 'none'}} />
                </div>
                <button onClick={clearWins} className="btn w-full text-sm" style={{background: 'rgba(239,68,68,0.3)', color: '#fca5a5'}}>Ã°Å¸â€”â€˜Ã¯Â¸Â Clear All Wins</button>
              </div>

              <p className="text-center text-xs mt-4" style={{color: 'rgba(255,255,255,0.4)'}}>
                Wins are saved on this device. Use Export to backup.<br/>
                Version {APP_VERSION} {firebaseConfigured ? 'â€¢ Cloud Sync Ready' : 'â€¢ Local Mode'}
              </p>
            </div>
          </div>
        );
      };

      if (showLeaderboard) return <LeaderboardScreen />;

      // YAHTZEE
      const YahtzeeReference = () => (
        <div>
          <div className="card">
            <h3 className="text-white font-semibold mb-3">ðŸŽ¯ Upper Section</h3>
            <p className="text-light text-xs mb-3">Add up only dice showing that number</p>
            {YAHTZEE_CATEGORIES.upper.map(cat => (
              <div key={cat.key} className="score-item"><span className="text-white">{cat.icon} {cat.name}</span><span className="text-light">Sum of {cat.name.toLowerCase()}</span></div>
            ))}
            <div className="score-highlight mt-3">
              <div className="flex justify-between"><span className="text-amber font-semibold">âœ‹Â¨ BONUS</span><span className="text-amber font-bold">+35 pts</span></div>
              <p className="text-light text-xs mt-1">If upper section â‰¥ 63 (avg 3 of each)</p>
            </div>
          </div>
          <div className="card">
            <h3 className="text-white font-semibold mb-3">ðŸŽ¯ Lower Section</h3>
            <div className="score-item"><span className="text-white">ðŸŽ² 3 of a Kind</span><span className="text-light">Sum all dice</span></div>
            <div className="score-item"><span className="text-white">ðŸŽ² 4 of a Kind</span><span className="text-light">Sum all dice</span></div>
            <div className="score-item"><span className="text-white">Ã°Å¸ÂÂ  Full House</span><span className="text-amber font-bold">25 pts</span></div>
            <div className="score-item"><span className="text-white">Ã°Å¸â€œË† Sm Straight</span><span className="text-amber font-bold">30 pts</span></div>
            <div className="score-item"><span className="text-white">Ã°Å¸â€œË† Lg Straight</span><span className="text-amber font-bold">40 pts</span></div>
            <div className="score-item"><span className="text-white">ðŸŒŸ YAHTZEE</span><span className="text-amber font-bold">50 pts</span></div>
            <div className="score-item"><span className="text-white">Ã¢Ââ€œ Chance</span><span className="text-light">Sum all dice</span></div>
          </div>
          <div className="card">
            <h3 className="text-white font-semibold mb-3">Ã°Å¸â€œË† Straights</h3>
            <div className="score-highlight">
              <div className="flex justify-between mb-2"><span className="text-white font-medium">Small Straight</span><span className="text-green font-bold">30 pts</span></div>
              <p className="text-light text-sm mb-2">4 in a row (5th can be anything)</p>
              <div className="text-xs text-light">âœ‹â€œ 1-2-3-4 &nbsp; âœ‹â€œ 2-3-4-5 &nbsp; âœ‹â€œ 3-4-5-6<br/>Example: 1-2-3-4-4 = âœ‹â€œ</div>
            </div>
            <div className="score-highlight mt-2">
              <div className="flex justify-between mb-2"><span className="text-white font-medium">Large Straight</span><span className="text-amber font-bold">40 pts</span></div>
              <p className="text-light text-sm mb-2">All 5 in sequence</p>
              <div className="text-xs text-light">âœ‹â€œ 1-2-3-4-5 &nbsp; âœ‹â€œ 2-3-4-5-6<br/>âœ‹â€” 1-2-3-5-6 (missing 4)</div>
            </div>
          </div>
        </div>
      );

      const YahtzeeScorecard = () => {
        const currentPlayer = players[currentPlayerIndex];
        const getUpperTotal = (p) => YAHTZEE_CATEGORIES.upper.reduce((sum, cat) => sum + (p.yahtzeeScores?.[cat.key] || 0), 0);
        return (
          <div>
            <div className="current-player">
              <span className="text-amber text-sm">Now scoring:</span>
              <h3 className="text-white text-xl font-bold">{currentPlayer?.name}</h3>
            </div>
            <div className="player-tabs mb-4">
              {players.map((p, idx) => (
                <button key={p.id} onClick={() => setCurrentPlayerIndex(idx)} className={`player-tab ${idx === currentPlayerIndex ? 'active' : ''}`}>{p.name}: {p.total}</button>
              ))}
            </div>
            <div className="card">
              <h3 className="text-white font-semibold mb-2 text-sm">Upper Section</h3>
              <div className="grid grid-3 gap-2">
                {YAHTZEE_CATEGORIES.upper.map(cat => {
                  const score = currentPlayer?.yahtzeeScores?.[cat.key];
                  const isUsed = score !== undefined;
                  return (
                    <button key={cat.key} onClick={() => isUsed ? startEditYahtzee(currentPlayer.id, cat.key, score) : setSelectedCategory(cat.key)}
                      className={`category-btn ${isUsed ? 'used' : selectedCategory === cat.key ? 'selected' : 'available'}`}>
                      <div className="text-lg">{cat.icon}</div><div className="text-xs">{cat.name}</div>
                      {isUsed && <div className="font-bold">{score}</div>}
                    </button>
                  );
                })}
              </div>
              <div className="divider flex justify-between text-sm">
                <span className="text-light">Upper: {getUpperTotal(currentPlayer)}/63</span>
                <span className={currentPlayer?.yahtzeeBonus > 0 ? 'text-amber' : 'text-light'}>Bonus: {currentPlayer?.yahtzeeBonus || 0}</span>
              </div>
            </div>
            <div className="card">
              <h3 className="text-white font-semibold mb-2 text-sm">Lower Section</h3>
              <div className="grid grid-2 gap-2">
                {YAHTZEE_CATEGORIES.lower.map(cat => {
                  const score = currentPlayer?.yahtzeeScores?.[cat.key];
                  const isUsed = score !== undefined;
                  return (
                    <button key={cat.key} onClick={() => isUsed ? startEditYahtzee(currentPlayer.id, cat.key, score) : setSelectedCategory(cat.key)}
                      className={`category-btn ${isUsed ? 'used' : selectedCategory === cat.key ? 'selected' : 'available'}`} style={{textAlign: 'left'}}>
                      <div className="flex justify-between items-center">
                        <span className="text-sm">{cat.icon} {cat.name}</span>
                        {isUsed && <span className="font-bold">{score}</span>}
                      </div>
                    </button>
                  );
                })}
              </div>
            </div>
            {selectedCategory && (
              <div className="card" style={{background: 'rgba(245, 158, 11, 0.2)'}}>
                <div className="text-center mb-3">
                  <span className="text-light">Enter score for </span>
                  <span className="text-white font-semibold">{[...YAHTZEE_CATEGORIES.upper, ...YAHTZEE_CATEGORIES.lower].find(c => c.key === selectedCategory)?.name}</span>
                </div>
                <div className="flex gap-2">
                  <input type="text" inputMode="numeric" value={scoreInput} onChange={(e) => setScoreInput(e.target.value)} placeholder="0" className="input input-score flex-1" style={{fontSize: '20px'}} autoFocus />
                  <button onClick={submitYahtzeeScore} className="btn accent-amber text-white">âœ‹â€œ</button>
                </div>
                <button onClick={() => { setSelectedCategory(null); setScoreInput(''); }} className="btn btn-primary w-full mt-2 text-sm" style={{padding: '8px'}}>Cancel</button>
              </div>
            )}
            <div className="card">
              <div className="flex justify-between items-center">
                <span className="text-white font-semibold">Grand Total</span>
                <span className="text-white text-2xl font-bold">{currentPlayer?.total || 0}</span>
              </div>
            </div>
            <p className="text-light text-xs text-center mt-2">Ã°Å¸â€™Â¡ Tap any filled score to edit it</p>
          </div>
        );
      };

      // PHASE 10
      const Phase10Reference = () => {
        const currentPlayer = players[currentPlayerIndex];
        return (
          <div>
            <div className="card">
              <div className="flex justify-between items-center mb-3">
                <h3 className="text-white font-semibold">Phase Card</h3>
                <select value={currentPlayerIndex} onChange={(e) => setCurrentPlayerIndex(Number(e.target.value))} className="player-select">
                  {players.map((p, idx) => <option key={p.id} value={idx}>{p.name}</option>)}
                </select>
              </div>
              {PHASE10_PHASES.map(phase => {
                const isComplete = currentPlayer?.phase > phase.num;
                const isCurrent = currentPlayer?.phase === phase.num;
                return (
                  <div key={phase.num} className={`phase-item ${isComplete ? 'complete' : isCurrent ? 'current' : 'pending'}`}>
                    <div className={`phase-num ${isComplete ? 'complete' : isCurrent ? 'current' : 'pending'}`}>{isComplete ? 'âœ‹â€œ' : phase.num}</div>
                    <div className="flex-1">
                      <div className={`font-medium ${isComplete ? 'text-green' : isCurrent ? 'text-amber' : 'text-light'}`}>{phase.name}</div>
                      <div className="text-xs text-light">{phase.example}</div>
                    </div>
                  </div>
                );
              })}
            </div>
            <div className="card">
              <h3 className="text-white font-semibold mb-3">Ã¢Å¡Â Ã¯Â¸Â Penalty Points</h3>
              <div className="grid grid-2 gap-2">
                <div className="score-item flex-col text-center"><div className="text-white font-medium">1-9</div><div className="text-red">5 pts</div></div>
                <div className="score-item flex-col text-center"><div className="text-white font-medium">10-12</div><div className="text-red">10 pts</div></div>
                <div className="score-item flex-col text-center"><div className="text-white font-medium">Skip</div><div className="text-red">15 pts</div></div>
                <div className="score-item flex-col text-center"><div className="text-white font-medium">Wild</div><div className="text-red">25 pts</div></div>
              </div>
            </div>
          </div>
        );
      };

      const Phase10Scorecard = () => (
        <div>
          <div className="card">
            <h3 className="text-white font-semibold mb-3">Player Progress</h3>
            {sortedPlayers.map((player, index) => (
              <div key={player.id} className={`standing-item ${index === 0 ? 'leader' : ''}`}>
                <div className="flex justify-between items-center mb-2">
                  <span className="text-white font-medium">{player.name}</span>
                  <span className="text-light">{player.total} pts</span>
                </div>
                <div className="grid gap-1" style={{gridTemplateColumns: 'repeat(10, 1fr)'}}>
                  {[...Array(10)].map((_, i) => (
                    <div key={i} className={`phase-box ${player.phase > i + 1 ? 'complete' : player.phase === i + 1 ? 'current' : 'pending'}`}>{player.phase > i + 1 ? 'âœ‹â€œ' : i + 1}</div>
                  ))}
                </div>
              </div>
            ))}
          </div>
          <div className="card">
            <h3 className="text-white font-semibold mb-3">Round {currentRound} - Enter Scores</h3>
            {players.map(player => (
              <div key={player.id} className="mb-3">
                <div className="score-entry">
                  <div className="score-entry-name">{player.name}<span className="score-entry-phase">Phase {player.phase <= 10 ? player.phase : 'âœ‹â€œ'}</span></div>
                  <button onClick={() => setEditingRoundScore({playerId: player.id, value: roundScores[player.id] || ''})} 
                    className="input input-score" style={{cursor: 'pointer', minWidth: '80px'}}>
                    {roundScores[player.id] || 'Ã¢â‚¬â€'}
                  </button>
                </div>
                {player.phase <= 10 && (
                  <button onClick={() => togglePhaseAdvance(player.id)} className={`phase-toggle ${phaseAdvance[player.id] ? 'complete' : 'incomplete'}`}>
                    {phaseAdvance[player.id] ? `âœ‹â€œ Completed Phase ${player.phase}` : `Completed Phase ${player.phase}?`}
                  </button>
                )}
              </div>
            ))}
            <button onClick={submitRound} disabled={!players.every(p => roundScores[p.id] !== '' && roundScores[p.id] !== '-')} className="btn accent-blue text-white w-full mt-2">Submit Round</button>
          </div>
          {players[0]?.scores.length > 0 && (
            <div className="card">
              <h3 className="text-white font-semibold mb-3">History <span className="text-light text-xs font-normal">(tap to edit)</span></h3>
              <div className="overflow-x">
                <table className="history-table">
                  <thead><tr><th className="text-left">Player</th>{players[0].scores.map((_, i) => <th key={i} className="text-center">R{i + 1}</th>)}</tr></thead>
                  <tbody>{players.map(player => (
                    <tr key={player.id}><td>{player.name}</td>{player.scores.map((score, i) => (
                      <td key={i} className="text-center"><span className={`editable ${score === 0 ? 'zero' : ''}`} onClick={() => startEditScore(player.id, i, score)}>{score}</span></td>
                    ))}</tr>
                  ))}</tbody>
                </table>
              </div>
            </div>
          )}
        </div>
      );

      // FARKLE
      const FarkleReference = () => (
        <div>
          <div className="card">
            <h3 className="text-white font-semibold mb-3">ðŸŽ² Single Dice</h3>
            <div className="grid grid-2 gap-2">
              <div className="score-highlight text-center"><span className="dice text-3xl">Ã¢Å¡â‚¬</span><div className="text-green font-bold mt-1">100 pts</div></div>
              <div className="score-highlight text-center"><span className="dice text-3xl">Ã¢Å¡â€ž</span><div className="text-green font-bold mt-1">50 pts</div></div>
            </div>
            <div className="score-warning mt-3 text-center"><span className="text-light text-sm">Ã¢Å¡Â Ã¯Â¸Â Single 2, 3, 4, 6 = 0 points!</span></div>
          </div>
          <div className="card">
            <h3 className="text-white font-semibold mb-3">ðŸŽ²ðŸŽ²ðŸŽ² Three of a Kind</h3>
            <div className="score-item"><span className="dice text-lg">Ã¢Å¡â‚¬Ã¢Å¡â‚¬Ã¢Å¡â‚¬</span><span className="text-amber font-bold">1,000</span></div>
            <div className="score-item"><span className="dice text-lg">Ã¢Å¡ÂÃ¢Å¡ÂÃ¢Å¡Â</span><span className="text-amber font-bold">200</span></div>
            <div className="score-item"><span className="dice text-lg">Ã¢Å¡â€šÃ¢Å¡â€šÃ¢Å¡â€š</span><span className="text-amber font-bold">300</span></div>
            <div className="score-item"><span className="dice text-lg">Ã¢Å¡Æ’Ã¢Å¡Æ’Ã¢Å¡Æ’</span><span className="text-amber font-bold">400</span></div>
            <div className="score-item"><span className="dice text-lg">Ã¢Å¡â€žÃ¢Å¡â€žÃ¢Å¡â€ž</span><span className="text-amber font-bold">500</span></div>
            <div className="score-item"><span className="dice text-lg">Ã¢Å¡â€¦Ã¢Å¡â€¦Ã¢Å¡â€¦</span><span className="text-amber font-bold">600</span></div>
          </div>
          <div className="card">
            <h3 className="text-white font-semibold mb-3">4+ of a Kind</h3>
            <div className="score-item"><span className="text-white">4 of a Kind</span><span className="text-amber">2Ãƒâ€” triple</span></div>
            <div className="score-item"><span className="text-white">5 of a Kind</span><span className="text-amber">4Ãƒâ€” triple</span></div>
            <div className="score-item"><span className="text-white">6 of a Kind</span><span className="text-amber">8Ãƒâ€” triple</span></div>
          </div>
          <div className="card">
            <h3 className="text-white font-semibold mb-3">âœ‹Â¨ Special Combos</h3>
            <div className="score-item"><span className="text-white">Straight 1-6</span><span className="text-amber font-bold">1,500</span></div>
            <div className="score-item"><span className="text-white">Three Pairs</span><span className="text-amber font-bold">1,500</span></div>
            <div className="score-item"><span className="text-white">Two Triplets</span><span className="text-amber font-bold">2,500</span></div>
          </div>
          <div className="card score-warning">
            <h3 className="text-red font-semibold mb-2">Ã¢Å¡Â Ã¯Â¸Â FARKLE!</h3>
            <p className="text-light text-sm">Roll with no scoring dice = lose all points from that turn!</p>
          </div>
        </div>
      );

      const FarkleScorecard = () => (
        <div>
          <div className="card">
            <div className="flex justify-between items-center mb-3"><h3 className="text-white font-semibold">Standings</h3><span className="text-light text-sm">First to 10,000</span></div>
            {sortedPlayers.map((player, index) => (
              <div key={player.id} className={`standing-item ${index === 0 && player.total > 0 ? 'leader' : ''}`}>
                <div className="flex items-center justify-between mb-1">
                  <div className="flex items-center gap-3">
                    <span className={`rank ${index === 0 && player.total > 0 ? 'leader' : 'text-purple'}`}>{index + 1}</span>
                    <span className="text-white font-medium">{player.name}</span>
                  </div>
                  <span className="text-white text-xl font-bold">{player.total.toLocaleString()}</span>
                </div>
                <div className="progress-bar" style={{marginLeft: '36px'}}><div className="progress-fill" style={{width: `${Math.min((player.total / 10000) * 100, 100)}%`}}></div></div>
              </div>
            ))}
          </div>
          <div className="card">
            <h3 className="text-white font-semibold mb-3">Enter Turn Scores</h3>
            {players.map(player => (
              <div key={player.id} className="score-entry">
                <span className="score-entry-name">{player.name}</span>
                <button onClick={() => setEditingRoundScore({playerId: player.id, value: roundScores[player.id] || ''})} 
                  className="input input-score" style={{cursor: 'pointer', minWidth: '80px'}}>
                  {roundScores[player.id] || 'Ã¢â‚¬â€'}
                </button>
              </div>
            ))}
            <button onClick={submitRound} disabled={!players.every(p => roundScores[p.id] !== '' && roundScores[p.id] !== '-')} className="btn accent-purple text-white w-full mt-2">Submit Round</button>
          </div>
          {players[0]?.scores.length > 0 && (
            <div className="card">
              <h3 className="text-white font-semibold mb-3">History <span className="text-light text-xs font-normal">(tap to edit)</span></h3>
              <div className="overflow-x">
                <table className="history-table">
                  <thead><tr><th className="text-left">Player</th>{players[0].scores.slice(-6).map((_, i) => <th key={i} className="text-center">{players[0].scores.length > 6 ? players[0].scores.length - 6 + i + 1 : i + 1}</th>)}</tr></thead>
                  <tbody>{players.map(player => (
                    <tr key={player.id}><td>{player.name}</td>{player.scores.slice(-6).map((score, i) => {
                      const actualIndex = player.scores.length > 6 ? player.scores.length - 6 + i : i;
                      return <td key={i} className="text-center"><span className={`editable ${score === 0 ? 'farkle' : ''}`} onClick={() => startEditScore(player.id, actualIndex, score)}>{score === 0 ? 'F' : score.toLocaleString()}</span></td>;
                    })}</tr>
                  ))}</tbody>
                </table>
              </div>
            </div>
          )}
        </div>
      );

      // CRIBBAGE
      const CribbageReference = () => (
        <div>
          <div className="card">
            <h3 className="text-white font-semibold mb-3">ðŸŽ¯ Pegging Points</h3>
            <p className="text-light text-xs mb-3">Scored during card play</p>
            <div className="score-item"><span className="text-white">15 exactly</span><span className="text-green font-bold">2 pts</span></div>
            <div className="score-item"><span className="text-white">31 exactly</span><span className="text-green font-bold">2 pts</span></div>
            <div className="score-item"><span className="text-white">Pair</span><span className="text-green font-bold">2 pts</span></div>
            <div className="score-item"><span className="text-white">Three of a kind</span><span className="text-green font-bold">6 pts</span></div>
            <div className="score-item"><span className="text-white">Four of a kind</span><span className="text-green font-bold">12 pts</span></div>
            <div className="score-item"><span className="text-white">Run (3+ cards)</span><span className="text-green font-bold">1 per card</span></div>
            <div className="score-item"><span className="text-white">Go / Last card</span><span className="text-green font-bold">1 pt</span></div>
          </div>
          <div className="card">
            <h3 className="text-white font-semibold mb-3">ðŸƒÂ Hand Scoring</h3>
            <p className="text-light text-xs mb-3">Count your hand + starter card</p>
            <div className="score-item"><span className="text-white">Each combo = 15</span><span className="text-amber font-bold">2 pts</span></div>
            <div className="score-item"><span className="text-white">Each pair</span><span className="text-amber font-bold">2 pts</span></div>
            <div className="score-item"><span className="text-white">Run (3+ sequence)</span><span className="text-amber font-bold">1 per card</span></div>
            <div className="score-item"><span className="text-white">Flush (4 same suit)</span><span className="text-amber font-bold">4 pts</span></div>
            <div className="score-item"><span className="text-white">Flush + starter</span><span className="text-amber font-bold">5 pts</span></div>
            <div className="score-item"><span className="text-white">Nobs (J of starter suit)</span><span className="text-amber font-bold">1 pt</span></div>
          </div>
          <div className="card">
            <h3 className="text-white font-semibold mb-3">Ã°Å¸â€™Â¡ Example 15s</h3>
            <p className="text-light text-sm mb-2">Hand: 5-5-5-J and starter: 5</p>
            <p className="text-lighter text-sm">â€¢ Four 5s = 12 pts (6 pairs)</p>
            <p className="text-lighter text-sm">â€¢ 5+5+5 = 15 (Ãƒâ€”4 ways) = 8 pts</p>
            <p className="text-lighter text-sm">â€¢ 5+J = 15 (Ãƒâ€”4 ways) = 8 pts</p>
            <p className="text-green text-sm font-semibold mt-2">Total: 28 pts! (Max without flush)</p>
          </div>
          <div className="card score-warning">
            <h3 className="text-amber font-semibold mb-2">ðŸ¦¨ Skunk!</h3>
            <p className="text-light text-sm">If winner reaches 121 before loser hits 91, it's a skunk Ã¢â‚¬â€ counts as double win!</p>
          </div>
        </div>
      );

      const PitchReference = () => (
        <div>
          <div className="card">
            <h3 className="text-white font-semibold mb-3">ðŸŽ¯ 10-Point Cards</h3>
            <p className="text-light text-xs mb-3">Trump suit only</p>
            <div className="score-item"><span className="text-white">Ace (High)</span><span className="text-purple font-bold">1 pt</span></div>
            <div className="score-item"><span className="text-white">Jack</span><span className="text-purple font-bold">1 pt</span></div>
            <div className="score-item"><span className="text-white">Off-Jack (Jick)</span><span className="text-purple font-bold">1 pt</span></div>
            <div className="score-item"><span className="text-white">High Joker</span><span className="text-purple font-bold">1 pt</span></div>
            <div className="score-item"><span className="text-white">Low Joker</span><span className="text-purple font-bold">1 pt</span></div>
            <div className="score-item"><span className="text-white">10</span><span className="text-purple font-bold">1 pt</span></div>
            <div className="score-item"><span className="text-white">3</span><span className="text-amber font-bold">3 pts</span></div>
            <div className="score-item"><span className="text-white">2 (Low)</span><span className="text-green font-bold">1 pt â†â€™ Holder</span></div>
          </div>
          <div className="card">
            <h3 className="text-white font-semibold mb-3">ðŸŽ¯ 13-Point (adds)</h3>
            <div className="score-item"><span className="text-white">Off-3 (same color)</span><span className="text-amber font-bold">3 pts</span></div>
          </div>
          <div className="card">
            <h3 className="text-white font-semibold mb-3">Ã°Å¸â€œÅ  Trump Card Rank</h3>
            <p className="text-lighter text-sm" style={{lineHeight: '1.6'}}>
              A K Q J <span style={{color: '#c4b5fd'}}>Jick</span> <span style={{color: '#fbbf24'}}>HiðŸƒÂ LoðŸƒÂ</span> 10 9 8 7 6 5 4 <span style={{color: '#fbbf24'}}>3</span> 2
            </p>
            <p className="text-light text-xs mt-2">Jick = Jack of same color, different suit</p>
          </div>
          <div className="card">
            <h3 className="text-white font-semibold mb-3">ðŸŽ® Call Your Partner</h3>
            <p className="text-lighter text-sm mb-2">â€¢ Bidder calls a trump card</p>
            <p className="text-lighter text-sm mb-2">â€¢ Holder of card is secret partner</p>
            <p className="text-lighter text-sm mb-2">â€¢ If card in deck â†â€™ bidder vs table!</p>
            <p className="text-lighter text-sm">â€¢ Partners share points won</p>
          </div>
          <div className="card score-warning">
            <h3 className="text-amber font-semibold mb-2">ðŸŒ™ Shoot the Moon</h3>
            <p className="text-light text-sm">Bid to take ALL points. High risk, high reward!</p>
          </div>
        </div>
      );

      const CribbageBoard = () => {
        const getStreet = (score) => {
          if (score <= 30) return 1;
          if (score <= 60) return 2;
          if (score <= 90) return 3;
          return 4;
        };

        const getStreetProgress = (score, street) => {
          const streetStart = (street - 1) * 30;
          const streetEnd = street * 30;
          if (score < streetStart) return 0;
          if (score >= streetEnd) return 100;
          return ((score - streetStart) / 30) * 100;
        };

        const p1 = players[0];
        const p2 = players[1];

        // Add points to current round (peg or show phase)
        const addPoints = (playerIndex, points) => {
          const isP1 = playerIndex === 0;
          if (cribbageCurrentRound.phase === 'peg' && !cribbageCurrentRound.pegConfirmed) {
            setCribbageCurrentRound({
              ...cribbageCurrentRound,
              [isP1 ? 'player1Peg' : 'player2Peg']: cribbageCurrentRound[isP1 ? 'player1Peg' : 'player2Peg'] + points
            });
          } else if (cribbageCurrentRound.phase === 'show' && !cribbageCurrentRound.showConfirmed) {
            setCribbageCurrentRound({
              ...cribbageCurrentRound,
              [isP1 ? 'player1Show' : 'player2Show']: cribbageCurrentRound[isP1 ? 'player1Show' : 'player2Show'] + points
            });
          }
        };

        // Confirm peg phase
        const confirmPeg = () => {
          const newP1Total = p1.total + cribbageCurrentRound.player1Peg;
          const newP2Total = p2.total + cribbageCurrentRound.player2Peg;

          setPlayers(players.map((p, i) => ({
            ...p,
            total: i === 0 ? newP1Total : newP2Total
          })));

          setCribbageCurrentRound({
            ...cribbageCurrentRound,
            phase: 'show',
            pegConfirmed: true
          });

          // Check for winner
          if (newP1Total >= 121) {
            setWinner({...p1, total: newP1Total});
            setScreen('winner');
          } else if (newP2Total >= 121) {
            setWinner({...p2, total: newP2Total});
            setScreen('winner');
          }
        };

        // Confirm show phase and complete round
        const confirmShow = () => {
          const newP1Total = p1.total + cribbageCurrentRound.player1Show;
          const newP2Total = p2.total + cribbageCurrentRound.player2Show;

          setPlayers(players.map((p, i) => ({
            ...p,
            total: i === 0 ? newP1Total : newP2Total
          })));

          // Save round to history
          setCribbageRounds([...cribbageRounds, {
            roundNumber: cribbageRounds.length + 1,
            player1Peg: cribbageCurrentRound.player1Peg,
            player2Peg: cribbageCurrentRound.player2Peg,
            player1Show: cribbageCurrentRound.player1Show,
            player2Show: cribbageCurrentRound.player2Show,
            total1: newP1Total,
            total2: newP2Total
          }]);

          // Reset for next round
          setCribbageCurrentRound({
            phase: 'peg',
            player1Peg: 0,
            player2Peg: 0,
            player1Show: 0,
            player2Show: 0,
            pegConfirmed: false,
            showConfirmed: false
          });

          // Check for winner
          if (newP1Total >= 121) {
            setWinner({...p1, total: newP1Total});
            setScreen('winner');
          } else if (newP2Total >= 121) {
            setWinner({...p2, total: newP2Total});
            setScreen('winner');
          }
        };

        // Edit round from history
        const editRound = (roundIndex) => {
          const round = cribbageRounds[roundIndex];
          setEditingCribbage({
            type: 'round',
            roundIndex,
            player1Peg: String(round.player1Peg),
            player2Peg: String(round.player2Peg),
            player1Show: String(round.player1Show),
            player2Show: String(round.player2Show)
          });
        };

        // Save edited round
        const saveRoundEdit = () => {
          const { roundIndex, player1Peg, player2Peg, player1Show, player2Show } = editingCribbage;
          const newP1Peg = Math.max(0, parseInt(player1Peg) || 0);
          const newP2Peg = Math.max(0, parseInt(player2Peg) || 0);
          const newP1Show = Math.max(0, parseInt(player1Show) || 0);
          const newP2Show = Math.max(0, parseInt(player2Show) || 0);

          // Recalculate totals from scratch
          let runningP1 = 0;
          let runningP2 = 0;
          const updatedRounds = cribbageRounds.map((r, i) => {
            if (i === roundIndex) {
              runningP1 += newP1Peg + newP1Show;
              runningP2 += newP2Peg + newP2Show;
              return {
                ...r,
                player1Peg: newP1Peg,
                player2Peg: newP2Peg,
                player1Show: newP1Show,
                player2Show: newP2Show,
                total1: runningP1,
                total2: runningP2
              };
            } else {
              runningP1 += r.player1Peg + r.player1Show;
              runningP2 += r.player2Peg + r.player2Show;
              return {...r, total1: runningP1, total2: runningP2};
            }
          });

          setCribbageRounds(updatedRounds);
          setPlayers(players.map((p, i) => ({
            ...p,
            total: i === 0 ? runningP1 : runningP2
          })));
          setEditingCribbage(null);
        };
        

        return (
          <div className="cribbage-layout">
            <div className="card cribbage-board-card">
              <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '20px'}}>
                <div style={{textAlign: 'center'}}>
                  <div style={{color: '#fca5a5', fontSize: '14px', fontWeight: '600'}}>ðŸ”´ {p1?.name}</div>
                  <div style={{color: 'white', fontSize: '36px', fontWeight: 'bold'}}>{p1?.total || 0}</div>
                  <div style={{color: 'rgba(255,255,255,0.5)', fontSize: '11px'}}>Street {getStreet(p1?.total || 0)}</div>
                </div>
                <div style={{textAlign: 'center'}}>
                  <div style={{color: '#93c5fd', fontSize: '14px', fontWeight: '600'}}>ðŸ”µ {p2?.name}</div>
                  <div style={{color: 'white', fontSize: '36px', fontWeight: 'bold'}}>{p2?.total || 0}</div>
                  <div style={{color: 'rgba(255,255,255,0.5)', fontSize: '11px'}}>Street {getStreet(p2?.total || 0)}</div>
                </div>
              </div>

              {/* Track - 4 streets */}
              <div style={{marginBottom: '12px'}}>
                {[4, 3, 2, 1].map(street => {
                  const isReverse = street % 2 === 0;
                  const startNum = isReverse ? street * 30 : (street - 1) * 30 + 1;
                  const endNum = isReverse ? (street - 1) * 30 + 1 : street * 30;
                  return (
                    <div key={street} style={{display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '6px'}}>
                      <span style={{fontSize: '10px', color: 'rgba(255,255,255,0.4)', width: '24px', textAlign: 'right'}}>{startNum}</span>
                      <div style={{flex: 1, height: '20px', background: 'rgba(255,255,255,0.1)', borderRadius: '10px', position: 'relative', overflow: 'hidden'}}>
                        <div style={{
                          position: 'absolute', top: '2px', height: '7px', borderRadius: '6px',
                          background: 'linear-gradient(90deg, #dc2626, #f87171)',
                          width: `${getStreetProgress(p1?.total || 0, street)}%`,
                          ...(isReverse ? {right: 0} : {left: 0})
                        }}></div>
                        <div style={{
                          position: 'absolute', bottom: '2px', height: '7px', borderRadius: '6px',
                          background: 'linear-gradient(90deg, #2563eb, #60a5fa)',
                          width: `${getStreetProgress(p2?.total || 0, street)}%`,
                          ...(isReverse ? {right: 0} : {left: 0})
                        }}></div>
                      </div>
                      <span style={{fontSize: '10px', color: 'rgba(255,255,255,0.4)', width: '24px'}}>{endNum}</span>
                    </div>
                  );
                })}
                <div style={{display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px', marginTop: '8px', padding: '8px', background: 'rgba(255,255,255,0.1)', borderRadius: '10px'}}>
                  <span style={{fontSize: '16px'}}>ðŸ</span>
                  <span style={{color: 'rgba(255,255,255,0.7)', fontSize: '12px', fontWeight: '600'}}>121 to win!</span>
                </div>
              </div>

              {/* Skunk warning */}
              {((p1?.total >= 91 && p2?.total < 91) || (p2?.total >= 91 && p1?.total < 91)) && (
                <div style={{background: 'rgba(245, 158, 11, 0.2)', borderRadius: '10px', padding: '10px', textAlign: 'center', marginTop: '12px'}}>
                  <span style={{color: '#fcd34d', fontSize: '13px'}}>ðŸ¦¨ Skunk alert! {p1?.total < 91 ? p1?.name : p2?.name} under 91</span>
                </div>
              )}
            </div>

            {/* Current Round Scoring */}
            <div className="card">
              <h3 className="text-white font-semibold mb-3 text-center">
                Round {cribbageRounds.length + 1} - {cribbageCurrentRound.phase === 'peg' ? 'ðŸŽ¯ Pegging' : 'âœ‹ Show'}
              </h3>

              {!cribbageCurrentRound.pegConfirmed && (
                <div style={{marginBottom: '16px'}}>
                  <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '12px', padding: '12px', background: 'rgba(255,255,255,0.1)', borderRadius: '8px'}}>
                    <div style={{textAlign: 'center', flex: 1}}>
                      <div style={{color: '#fca5a5', fontSize: '12px', marginBottom: '4px'}}>ðŸ”´ {p1?.name}</div>
                      <div style={{color: 'white', fontSize: '24px', fontWeight: 'bold'}}>{cribbageCurrentRound.player1Peg}</div>
                      <div style={{color: 'rgba(255,255,255,0.5)', fontSize: '11px'}}>peg points</div>
                    </div>
                    <div style={{textAlign: 'center', flex: 1}}>
                      <div style={{color: '#93c5fd', fontSize: '12px', marginBottom: '4px'}}>ðŸ”µ {p2?.name}</div>
                      <div style={{color: 'white', fontSize: '24px', fontWeight: 'bold'}}>{cribbageCurrentRound.player2Peg}</div>
                      <div style={{color: 'rgba(255,255,255,0.5)', fontSize: '11px'}}>peg points</div>
                    </div>
                  </div>

                  <div style={{display: 'flex', gap: '12px', marginBottom: '12px'}}>
                    <div style={{flex: 1, background: 'rgba(220,38,38,0.15)', borderRadius: '12px', padding: '12px'}}>
                      <div style={{color: '#fca5a5', fontSize: '12px', fontWeight: '600', textAlign: 'center', marginBottom: '8px'}}>ðŸ”´ {p1?.name}</div>
                      <div className="cribbage-points-grid" style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '6px'}}>
                        {[1, 2, 3, 4, 6, 8, 12].map(pts => (
                          <button key={pts} onClick={() => addPoints(0, pts)}
                            style={{background: '#dc2626', border: 'none', color: 'white', padding: '10px 0', borderRadius: '8px', fontSize: '14px', fontWeight: '600', cursor: 'pointer'}}>
                            +{pts}
                          </button>
                        ))}
                      </div>
                    </div>
                    <div style={{flex: 1, background: 'rgba(37,99,235,0.15)', borderRadius: '12px', padding: '12px'}}>
                      <div style={{color: '#93c5fd', fontSize: '12px', fontWeight: '600', textAlign: 'center', marginBottom: '8px'}}>ðŸ”µ {p2?.name}</div>
                      <div className="cribbage-points-grid" style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '6px'}}>
                        {[1, 2, 3, 4, 6, 8, 12].map(pts => (
                          <button key={pts} onClick={() => addPoints(1, pts)}
                            style={{background: '#2563eb', border: 'none', color: 'white', padding: '10px 0', borderRadius: '8px', fontSize: '14px', fontWeight: '600', cursor: 'pointer'}}>
                            +{pts}
                          </button>
                        ))}
                      </div>
                    </div>
                  </div>

                  <button onClick={confirmPeg} disabled={cribbageCurrentRound.player1Peg === 0 && cribbageCurrentRound.player2Peg === 0}
                    style={{width: '100%', padding: '12px', background: '#047857', color: 'white', border: 'none', borderRadius: '8px', fontSize: '16px', fontWeight: '600', cursor: 'pointer', opacity: (cribbageCurrentRound.player1Peg === 0 && cribbageCurrentRound.player2Peg === 0) ? 0.5 : 1}}>
                    âœ“ Confirm Pegging
                  </button>
                </div>
              )}

              {cribbageCurrentRound.pegConfirmed && !cribbageCurrentRound.showConfirmed && (
                <div style={{marginBottom: '16px'}}>
                  <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '12px', padding: '12px', background: 'rgba(255,255,255,0.1)', borderRadius: '8px'}}>
                    <div style={{textAlign: 'center', flex: 1}}>
                      <div style={{color: '#fca5a5', fontSize: '12px', marginBottom: '4px'}}>ðŸ”´ {p1?.name}</div>
                      <div style={{color: 'white', fontSize: '24px', fontWeight: 'bold'}}>{cribbageCurrentRound.player1Show}</div>
                      <div style={{color: 'rgba(255,255,255,0.5)', fontSize: '11px'}}>show points</div>
                    </div>
                    <div style={{textAlign: 'center', flex: 1}}>
                      <div style={{color: '#93c5fd', fontSize: '12px', marginBottom: '4px'}}>ðŸ”µ {p2?.name}</div>
                      <div style={{color: 'white', fontSize: '24px', fontWeight: 'bold'}}>{cribbageCurrentRound.player2Show}</div>
                      <div style={{color: 'rgba(255,255,255,0.5)', fontSize: '11px'}}>show points</div>
                    </div>
                  </div>

                  <div style={{display: 'flex', gap: '12px', marginBottom: '12px'}}>
                    <div style={{flex: 1, background: 'rgba(220,38,38,0.15)', borderRadius: '12px', padding: '12px'}}>
                      <div style={{color: '#fca5a5', fontSize: '12px', fontWeight: '600', textAlign: 'center', marginBottom: '8px'}}>ðŸ”´ {p1?.name}</div>
                      <div className="cribbage-points-grid" style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '6px'}}>
                        {[1, 2, 4, 8, 12, 15, 24].map(pts => (
                          <button key={pts} onClick={() => addPoints(0, pts)}
                            style={{background: '#dc2626', border: 'none', color: 'white', padding: '10px 0', borderRadius: '8px', fontSize: '14px', fontWeight: '600', cursor: 'pointer'}}>
                            +{pts}
                          </button>
                        ))}
                      </div>
                    </div>
                    <div style={{flex: 1, background: 'rgba(37,99,235,0.15)', borderRadius: '12px', padding: '12px'}}>
                      <div style={{color: '#93c5fd', fontSize: '12px', fontWeight: '600', textAlign: 'center', marginBottom: '8px'}}>ðŸ”µ {p2?.name}</div>
                      <div className="cribbage-points-grid" style={{display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '6px'}}>
                        {[1, 2, 4, 8, 12, 15, 24].map(pts => (
                          <button key={pts} onClick={() => addPoints(1, pts)}
                            style={{background: '#2563eb', border: 'none', color: 'white', padding: '10px 0', borderRadius: '8px', fontSize: '14px', fontWeight: '600', cursor: 'pointer'}}>
                            +{pts}
                          </button>
                        ))}
                      </div>
                    </div>
                  </div>

                  <button onClick={confirmShow} disabled={cribbageCurrentRound.player1Show === 0 && cribbageCurrentRound.player2Show === 0}
                    style={{width: '100%', padding: '12px', background: '#047857', color: 'white', border: 'none', borderRadius: '8px', fontSize: '16px', fontWeight: '600', cursor: 'pointer', opacity: (cribbageCurrentRound.player1Show === 0 && cribbageCurrentRound.player2Show === 0) ? 0.5 : 1}}>
                    âœ“ Confirm Show & Complete Round
                  </button>
                </div>
              )}

              <p style={{textAlign: 'center', color: 'rgba(255,255,255,0.5)', fontSize: '10px', marginTop: '8px'}}>
                {cribbageCurrentRound.phase === 'peg' ? '+1 go/last â€¢ +2 pair/15/31 â€¢ +3 run â€¢ +6 trips â€¢ +12 quads' : 'Each 15=2 â€¢ Pairs=2 â€¢ Run=1/card â€¢ Flush=4/5 â€¢ Nobs=1'}
              </p>
            </div>

            {/* Round History */}
            {cribbageRounds.length > 0 && (
              <div className="card" style={{gridColumn: '1 / -1'}}>
                <h3 className="text-white font-semibold mb-3">ðŸ“‹ Round History</h3>
                <div style={{maxHeight: '300px', overflowY: 'auto'}}>
                  {cribbageRounds.slice().reverse().map((round, i) => {
                    const actualIndex = cribbageRounds.length - 1 - i;
                    return (
                      <div key={actualIndex} style={{marginBottom: '12px', padding: '12px', background: 'rgba(255,255,255,0.08)', borderRadius: '8px'}}>
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px'}}>
                          <div style={{color: 'rgba(255,255,255,0.7)', fontSize: '12px', fontWeight: '600'}}>Round {round.roundNumber}</div>
                          <button onClick={() => editRound(actualIndex)}
                            style={{background: 'rgba(255,255,255,0.2)', border: 'none', color: 'white', padding: '4px 8px', borderRadius: '6px', fontSize: '11px', cursor: 'pointer'}}>
                            âœï¸ Edit
                          </button>
                        </div>
                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px'}}>
                          <div>
                            <div style={{color: '#fca5a5', fontSize: '11px', marginBottom: '4px'}}>ðŸ”´ {p1?.name}</div>
                            <div style={{color: 'rgba(255,255,255,0.9)', fontSize: '13px'}}>Peg: {round.player1Peg} â€¢ Show: {round.player1Show}</div>
                            <div style={{color: 'rgba(255,255,255,0.6)', fontSize: '12px'}}>Total: {round.total1}</div>
                          </div>
                          <div>
                            <div style={{color: '#93c5fd', fontSize: '11px', marginBottom: '4px'}}>ðŸ”µ {p2?.name}</div>
                            <div style={{color: 'rgba(255,255,255,0.9)', fontSize: '13px'}}>Peg: {round.player2Peg} â€¢ Show: {round.player2Show}</div>
                            <div style={{color: 'rgba(255,255,255,0.6)', fontSize: '12px'}}>Total: {round.total2}</div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* Inline reference - shown on tablets */}
            <div className="tablet-only">
              <div className="card">
                <h3 className="text-white font-semibold mb-3">ðŸŽ¯ Quick Reference</h3>
                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px'}}>
                  <div>
                    <h4 style={{color: '#86efac', fontSize: '13px', fontWeight: '600', marginBottom: '8px'}}>Pegging</h4>
                    <div style={{fontSize: '13px', color: 'rgba(255,255,255,0.8)', lineHeight: '1.6'}}>
                      <div>15 or 31 = <strong>2</strong></div>
                      <div>Pair = <strong>2</strong></div>
                      <div>Trips = <strong>6</strong></div>
                      <div>Quads = <strong>12</strong></div>
                      <div>Run (3+) = <strong>1/card</strong></div>
                      <div>Go / Last = <strong>1</strong></div>
                    </div>
                  </div>
                  <div>
                    <h4 style={{color: '#fcd34d', fontSize: '13px', fontWeight: '600', marginBottom: '8px'}}>Hand Scoring</h4>
                    <div style={{fontSize: '13px', color: 'rgba(255,255,255,0.8)', lineHeight: '1.6'}}>
                      <div>Each 15 = <strong>2</strong></div>
                      <div>Each pair = <strong>2</strong></div>
                      <div>Run = <strong>1/card</strong></div>
                      <div>Flush (4) = <strong>4</strong></div>
                      <div>Flush (5) = <strong>5</strong></div>
                      <div>Nobs = <strong>1</strong></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // PITCH GAME
      const PitchGame = () => {
        const POINT_SYSTEMS = {
          4: { name: '4-Point', total: 4, defaultTarget: 11, minBid: 2 },
          5: { name: '5-Point', total: 5, defaultTarget: 21, minBid: 2 },
          7: { name: '7-Point', total: 7, defaultTarget: 21, minBid: 3 },
          10: { name: '10-Point', total: 10, defaultTarget: 52, minBid: 4 },
          13: { name: '13-Point', total: 13, defaultTarget: 52, minBid: 5 }
        };
        
        const pointSys = POINT_SYSTEMS[pitchConfig.pointSystem] || POINT_SYSTEMS[10];
        const effectiveTarget = pitchConfig.customTarget ? parseInt(pitchConfig.customTarget) : pitchConfig.targetScore;
        
        // Setup screen
        if (!pitchSetupDone) {
          return (
            <div>
              <div className="card">
                <h3 className="text-white font-semibold mb-4">Ã¢Å¡â„¢Ã¯Â¸Â Game Setup</h3>
                
                <div style={{marginBottom: '16px'}}>
                  <label className="text-light text-sm mb-2" style={{display: 'block'}}>Point System</label>
                  <div style={{display: 'flex', flexWrap: 'wrap', gap: '8px'}}>
                    {[4, 5, 7, 10, 13].map(pts => (
                      <button key={pts} onClick={() => setPitchConfig({...pitchConfig, pointSystem: pts, targetScore: POINT_SYSTEMS[pts].defaultTarget, customTarget: ''})}
                        style={{padding: '10px 16px', borderRadius: '8px', border: 'none', cursor: 'pointer',
                          background: pitchConfig.pointSystem === pts ? '#7c3aed' : 'rgba(255,255,255,0.2)',
                          color: 'white', fontWeight: '600', fontSize: '14px'}}>
                        {pts}-pt
                      </button>
                    ))}
                  </div>
                </div>
                
                <div style={{marginBottom: '16px'}}>
                  <label className="text-light text-sm mb-2" style={{display: 'block'}}>Game Mode</label>
                  <div style={{display: 'flex', flexWrap: 'wrap', gap: '8px'}}>
                    <button onClick={() => setPitchConfig({...pitchConfig, gameMode: 'teams'})}
                      style={{padding: '10px 16px', borderRadius: '8px', border: 'none', cursor: 'pointer',
                        background: pitchConfig.gameMode === 'teams' ? '#7c3aed' : 'rgba(255,255,255,0.2)',
                        color: 'white', fontWeight: '600', fontSize: '14px'}}>
                      Ã°Å¸â€˜Â¥ Teams
                    </button>
                    <button onClick={() => setPitchConfig({...pitchConfig, gameMode: 'callPartner'})}
                      style={{padding: '10px 16px', borderRadius: '8px', border: 'none', cursor: 'pointer',
                        background: pitchConfig.gameMode === 'callPartner' ? '#7c3aed' : 'rgba(255,255,255,0.2)',
                        color: 'white', fontWeight: '600', fontSize: '14px'}}>
                      ðŸŽ¯ Call Your Partner
                    </button>
                    <button onClick={() => setPitchConfig({...pitchConfig, gameMode: 'cutthroat'})}
                      style={{padding: '10px 16px', borderRadius: '8px', border: 'none', cursor: 'pointer',
                        background: pitchConfig.gameMode === 'cutthroat' ? '#7c3aed' : 'rgba(255,255,255,0.2)',
                        color: 'white', fontWeight: '600', fontSize: '14px'}}>
                      Ã°Å¸â€Âª Cutthroat
                    </button>
                  </div>
                </div>
                
                <div style={{marginBottom: '16px'}}>
                  <label className="text-light text-sm mb-2" style={{display: 'block'}}>Target Score</label>
                  <div style={{display: 'flex', flexWrap: 'wrap', gap: '8px', marginBottom: '8px'}}>
                    {[11, 21, 32, 42, 52].map(score => (
                      <button key={score} onClick={() => setPitchConfig({...pitchConfig, targetScore: score, customTarget: ''})}
                        style={{padding: '10px 16px', borderRadius: '8px', border: 'none', cursor: 'pointer',
                          background: pitchConfig.targetScore === score && !pitchConfig.customTarget ? '#7c3aed' : 'rgba(255,255,255,0.2)',
                          color: 'white', fontWeight: '600', fontSize: '14px'}}>
                        {score}
                      </button>
                    ))}
                  </div>
                  <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                    <span className="text-light text-sm">Custom:</span>
                    <input type="text" inputMode="numeric" value={pitchConfig.customTarget} 
                      onChange={(e) => setPitchConfig({...pitchConfig, customTarget: e.target.value})}
                      placeholder="Enter score" className="input" style={{width: '100px', padding: '8px 12px'}} />
                  </div>
                </div>
                
                <div style={{marginBottom: '16px'}}>
                  <label className="text-light text-sm mb-2" style={{display: 'block'}}>ðŸŒ™ Shoot the Moon - Success</label>
                  <div style={{display: 'flex', flexWrap: 'wrap', gap: '8px', marginBottom: '8px'}}>
                    <button onClick={() => setPitchConfig({...pitchConfig, moonReward: 'double'})}
                      style={{padding: '10px 14px', borderRadius: '8px', border: 'none', cursor: 'pointer',
                        background: pitchConfig.moonReward === 'double' ? '#22c55e' : 'rgba(255,255,255,0.2)',
                        color: 'white', fontWeight: '500', fontSize: '13px'}}>
                      Double Points
                    </button>
                    <button onClick={() => setPitchConfig({...pitchConfig, moonReward: 'autoWin'})}
                      style={{padding: '10px 14px', borderRadius: '8px', border: 'none', cursor: 'pointer',
                        background: pitchConfig.moonReward === 'autoWin' ? '#22c55e' : 'rgba(255,255,255,0.2)',
                        color: 'white', fontWeight: '500', fontSize: '13px'}}>
                      Auto-Win
                    </button>
                    <button onClick={() => setPitchConfig({...pitchConfig, moonReward: 'fixed'})}
                      style={{padding: '10px 14px', borderRadius: '8px', border: 'none', cursor: 'pointer',
                        background: pitchConfig.moonReward === 'fixed' ? '#22c55e' : 'rgba(255,255,255,0.2)',
                        color: 'white', fontWeight: '500', fontSize: '13px'}}>
                      + Fixed Points
                    </button>
                    <button onClick={() => setPitchConfig({...pitchConfig, moonReward: 'goTo'})}
                      style={{padding: '10px 14px', borderRadius: '8px', border: 'none', cursor: 'pointer',
                        background: pitchConfig.moonReward === 'goTo' ? '#22c55e' : 'rgba(255,255,255,0.2)',
                        color: 'white', fontWeight: '500', fontSize: '13px'}}>
                      Go To Score
                    </button>
                  </div>
                  {(pitchConfig.moonReward === 'fixed' || pitchConfig.moonReward === 'goTo') && (
                    <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                      <span className="text-light text-sm">{pitchConfig.moonReward === 'fixed' ? 'Add:' : 'Go to:'}</span>
                      <input type="text" inputMode="numeric" value={pitchConfig.moonRewardValue} 
                        onChange={(e) => setPitchConfig({...pitchConfig, moonRewardValue: parseInt(e.target.value) || 0})}
                        className="input" style={{width: '80px', padding: '8px 12px'}} />
                      <span className="text-light text-sm">pts</span>
                    </div>
                  )}
                  {pitchConfig.moonReward === 'autoWin' && (
                    <p style={{color: 'rgba(255,255,255,0.5)', fontSize: '11px', marginTop: '4px'}}>If negative â†â€™ resets to 0</p>
                  )}
                </div>
                
                <div style={{marginBottom: '16px'}}>
                  <label className="text-light text-sm mb-2" style={{display: 'block'}}>ðŸŒ™ Shoot the Moon - Miss</label>
                  <div style={{display: 'flex', flexWrap: 'wrap', gap: '8px', marginBottom: '8px'}}>
                    <button onClick={() => setPitchConfig({...pitchConfig, moonPenalty: 'set'})}
                      style={{padding: '10px 14px', borderRadius: '8px', border: 'none', cursor: 'pointer',
                        background: pitchConfig.moonPenalty === 'set' ? '#ef4444' : 'rgba(255,255,255,0.2)',
                        color: 'white', fontWeight: '500', fontSize: '13px'}}>
                      Lose Bid (-{pointSys.total})
                    </button>
                    <button onClick={() => setPitchConfig({...pitchConfig, moonPenalty: 'fixed'})}
                      style={{padding: '10px 14px', borderRadius: '8px', border: 'none', cursor: 'pointer',
                        background: pitchConfig.moonPenalty === 'fixed' ? '#ef4444' : 'rgba(255,255,255,0.2)',
                        color: 'white', fontWeight: '500', fontSize: '13px'}}>
                      Lose Fixed Points
                    </button>
                    <button onClick={() => setPitchConfig({...pitchConfig, moonPenalty: 'zero'})}
                      style={{padding: '10px 14px', borderRadius: '8px', border: 'none', cursor: 'pointer',
                        background: pitchConfig.moonPenalty === 'zero' ? '#ef4444' : 'rgba(255,255,255,0.2)',
                        color: 'white', fontWeight: '500', fontSize: '13px'}}>
                      Go to Zero
                    </button>
                    <button onClick={() => setPitchConfig({...pitchConfig, moonPenalty: 'loseGame'})}
                      style={{padding: '10px 14px', borderRadius: '8px', border: 'none', cursor: 'pointer',
                        background: pitchConfig.moonPenalty === 'loseGame' ? '#ef4444' : 'rgba(255,255,255,0.2)',
                        color: 'white', fontWeight: '500', fontSize: '13px'}}>
                      Lose Game
                    </button>
                  </div>
                  {pitchConfig.moonPenalty === 'fixed' && (
                    <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                      <span className="text-light text-sm">Lose:</span>
                      <input type="text" inputMode="numeric" value={pitchConfig.moonPenaltyValue} 
                        onChange={(e) => setPitchConfig({...pitchConfig, moonPenaltyValue: parseInt(e.target.value) || 0})}
                        className="input" style={{width: '80px', padding: '8px 12px'}} />
                      <span className="text-light text-sm">pts</span>
                    </div>
                  )}
                </div>
                
                <button onClick={() => setPitchSetupDone(true)}
                  style={{width: '100%', padding: '14px', borderRadius: '12px', border: 'none', cursor: 'pointer',
                    background: '#7c3aed', color: 'white', fontWeight: '600', fontSize: '16px', marginTop: '8px'}}>
                  Start Game
                </button>
              </div>
            </div>
          );
        }
        
        // For teams mode - use player 0 for team 1 score, player 1 for team 2 score
        const team1Score = pitchConfig.gameMode === 'teams' ? (players[0]?.total || 0) : 0;
        const team2Score = pitchConfig.gameMode === 'teams' ? (players[1]?.total || 0) : 0;
        const team1Names = pitchConfig.gameMode === 'teams' ? [players[0], players[2]].filter(Boolean).map(p => p.name).join(' & ') : '';
        const team2Names = pitchConfig.gameMode === 'teams' ? [players[1], players[3]].filter(Boolean).map(p => p.name).join(' & ') : '';
        
        return (
          <div>
            {/* Standings */}
            <div className="card">
              <div className="flex justify-between items-center mb-3">
                <h3 className="text-white font-semibold">Standings</h3>
                <span className="text-light text-sm">First to {effectiveTarget}</span>
              </div>
              
              {pitchConfig.gameMode === 'teams' ? (
                <div>
                  <div style={{display: 'flex', gap: '12px', marginBottom: '12px'}}>
                    <div onClick={() => setEditingPitch({team: 1, value: String(team1Score)})}
                      style={{flex: 1, background: 'rgba(124,58,237,0.2)', borderRadius: '12px', padding: '12px', textAlign: 'center', cursor: 'pointer'}}>
                      <div style={{color: '#c4b5fd', fontSize: '12px', marginBottom: '4px'}}>Team 1</div>
                      <div style={{color: 'white', fontSize: '24px', fontWeight: 'bold', textDecoration: 'underline', textDecorationStyle: 'dotted'}}>{team1Score}</div>
                      <div style={{color: 'rgba(255,255,255,0.6)', fontSize: '11px'}}>{team1Names}</div>
                    </div>
                    <div onClick={() => setEditingPitch({team: 2, value: String(team2Score)})}
                      style={{flex: 1, background: 'rgba(236,72,153,0.2)', borderRadius: '12px', padding: '12px', textAlign: 'center', cursor: 'pointer'}}>
                      <div style={{color: '#f9a8d4', fontSize: '12px', marginBottom: '4px'}}>Team 2</div>
                      <div style={{color: 'white', fontSize: '24px', fontWeight: 'bold', textDecoration: 'underline', textDecorationStyle: 'dotted'}}>{team2Score}</div>
                      <div style={{color: 'rgba(255,255,255,0.6)', fontSize: '11px'}}>{team2Names}</div>
                    </div>
                  </div>
                  <p style={{textAlign: 'center', color: 'rgba(255,255,255,0.4)', fontSize: '10px'}}>Tap score to edit</p>
                </div>
              ) : (
                <div>
                  {sortedPlayers.map((player, index) => (
                    <div key={player.id} onClick={() => setEditingPitch({playerIndex: players.findIndex(p => p.id === player.id), value: String(player.total)})}
                      className={`standing-item ${index === 0 && player.total > 0 ? 'leader' : ''}`} style={{cursor: 'pointer'}}>
                      <div className="flex items-center justify-between mb-1">
                        <div className="flex items-center gap-3">
                          <span className={`rank ${index === 0 && player.total > 0 ? 'leader' : ''}`}>{index + 1}</span>
                          <span className="text-white font-medium">{player.name}</span>
                        </div>
                        <span className="text-white text-xl font-bold" style={{textDecoration: 'underline', textDecorationStyle: 'dotted'}}>{player.total}</span>
                      </div>
                    </div>
                  ))}
                  <p style={{textAlign: 'center', color: 'rgba(255,255,255,0.4)', fontSize: '10px', marginTop: '8px'}}>Tap score to edit</p>
                </div>
              )}
            </div>
            
            {/* Hand Entry */}
            <div className="card">
              <h3 className="text-white font-semibold mb-3">Ã°Å¸â€œÂ Record Hand</h3>
              
              {/* Dealer */}
              <div style={{marginBottom: '12px'}}>
                <label className="text-light text-sm mb-2" style={{display: 'block'}}>Dealer</label>
                <div style={{display: 'flex', flexWrap: 'wrap', gap: '6px'}}>
                  {players.map((p, i) => (
                    <button key={p.id} onClick={() => setPitchHand({...pitchHand, dealerIndex: i})}
                      style={{padding: '8px 12px', borderRadius: '8px', border: 'none', cursor: 'pointer',
                        background: pitchHand.dealerIndex === i ? '#7c3aed' : 'rgba(255,255,255,0.15)',
                        color: 'white', fontSize: '13px'}}>
                      {p.name}
                    </button>
                  ))}
                </div>
              </div>
              
              {/* Bidder */}
              <div style={{marginBottom: '12px'}}>
                <label className="text-light text-sm mb-2" style={{display: 'block'}}>Bidder</label>
                <div style={{display: 'flex', flexWrap: 'wrap', gap: '6px'}}>
                  {players.map((p, i) => (
                    <button key={p.id} onClick={() => setPitchHand({...pitchHand, bidderIndex: i, isMoon: false, pointsWon: undefined})}
                      style={{padding: '8px 12px', borderRadius: '8px', border: 'none', cursor: 'pointer',
                        background: pitchHand.bidderIndex === i && !pitchHand.isMoon ? '#7c3aed' : 'rgba(255,255,255,0.15)',
                        color: 'white', fontSize: '13px'}}>
                      {p.name}
                    </button>
                  ))}
                </div>
              </div>
              
              {pitchHand.bidderIndex !== null && (
                <div style={{marginBottom: '12px'}}>
                  <label className="text-light text-sm mb-2" style={{display: 'block'}}>Bid Amount</label>
                  <div style={{display: 'flex', flexWrap: 'wrap', gap: '6px'}}>
                    {Array.from({length: pointSys.total - pointSys.minBid + 1}, (_, i) => i + pointSys.minBid).map(bid => (
                      <button key={bid} onClick={() => setPitchHand({...pitchHand, bidAmount: bid, isMoon: false, pointsWon: undefined})}
                        style={{padding: '8px 14px', borderRadius: '8px', border: 'none', cursor: 'pointer',
                          background: pitchHand.bidAmount === bid && !pitchHand.isMoon ? '#7c3aed' : 'rgba(255,255,255,0.15)',
                          color: 'white', fontSize: '14px', fontWeight: '600'}}>
                        {bid}
                      </button>
                    ))}
                    <button onClick={() => setPitchHand({...pitchHand, bidAmount: pointSys.total, isMoon: true, pointsWon: undefined})}
                      style={{padding: '8px 14px', borderRadius: '8px', border: 'none', cursor: 'pointer',
                        background: pitchHand.isMoon ? '#fbbf24' : 'rgba(255,255,255,0.15)',
                        color: pitchHand.isMoon ? 'black' : 'white', fontSize: '14px', fontWeight: '600'}}>
                      ðŸŒ™ Moon
                    </button>
                  </div>
                </div>
              )}
              
              {/* Call Your Partner */}
              {pitchConfig.gameMode === 'callPartner' && pitchHand.bidderIndex !== null && pitchHand.bidAmount > 0 && (
                <div style={{marginBottom: '12px'}}>
                  <label className="text-light text-sm mb-2" style={{display: 'block'}}>Partner (who had called card?)</label>
                  <div style={{display: 'flex', flexWrap: 'wrap', gap: '6px'}}>
                    {players.map((p, i) => i !== pitchHand.bidderIndex && (
                      <button key={p.id} onClick={() => setPitchHand({...pitchHand, partnerIndex: i})}
                        style={{padding: '8px 12px', borderRadius: '8px', border: 'none', cursor: 'pointer',
                          background: pitchHand.partnerIndex === i ? '#22c55e' : 'rgba(255,255,255,0.15)',
                          color: 'white', fontSize: '13px'}}>
                        {p.name}
                      </button>
                    ))}
                    <button onClick={() => setPitchHand({...pitchHand, partnerIndex: -1})}
                      style={{padding: '8px 12px', borderRadius: '8px', border: 'none', cursor: 'pointer',
                        background: pitchHand.partnerIndex === -1 ? '#ef4444' : 'rgba(255,255,255,0.15)',
                        color: 'white', fontSize: '13px'}}>
                      ðŸƒÂ In Deck (solo)
                    </button>
                  </div>
                </div>
              )}
              
              {/* Points won */}
              {pitchHand.bidderIndex !== null && pitchHand.bidAmount > 0 && (
                <div style={{marginBottom: '16px'}}>
                  <label className="text-light text-sm mb-2" style={{display: 'block'}}>
                    Points won by {pitchConfig.gameMode === 'teams' ? 
                      (pitchHand.bidderIndex === 0 || pitchHand.bidderIndex === 2 ? 'Team 1' : 'Team 2') :
                      pitchConfig.gameMode === 'callPartner' ? 
                        (pitchHand.partnerIndex === -1 ? players[pitchHand.bidderIndex]?.name + ' (solo)' : 'bidder & partner') :
                        players[pitchHand.bidderIndex]?.name
                    }
                  </label>
                  <div style={{display: 'flex', flexWrap: 'wrap', gap: '6px'}}>
                    {Array.from({length: pointSys.total + 1}, (_, i) => i).map(pts => (
                      <button key={pts} onClick={() => setPitchHand({...pitchHand, pointsWon: pts})}
                        style={{padding: '10px 14px', borderRadius: '8px', border: 'none', cursor: 'pointer',
                          background: pitchHand.pointsWon === pts ? (pts >= pitchHand.bidAmount || pitchHand.isMoon ? '#22c55e' : '#ef4444') : 'rgba(255,255,255,0.15)',
                          color: 'white', fontSize: '14px', fontWeight: '600'}}>
                        {pts}
                      </button>
                    ))}
                  </div>
                  {pitchHand.pointsWon !== undefined && (
                    <p style={{marginTop: '8px', color: (pitchHand.isMoon ? pitchHand.pointsWon === pointSys.total : pitchHand.pointsWon >= pitchHand.bidAmount) ? '#86efac' : '#fca5a5', fontSize: '13px', fontWeight: '600'}}>
                      {pitchHand.isMoon ? (
                        pitchHand.pointsWon === pointSys.total ? 'ðŸŒ™ Moon made!' : 'ðŸŒ™ Moon missed!'
                      ) : (
                        pitchHand.pointsWon >= pitchHand.bidAmount ? 'âœ‹â€œ Made bid!' : 'âœ‹â€” Set!'
                      )}
                    </p>
                  )}
                </div>
              )}
              
              {/* Submit Hand */}
              {pitchHand.bidderIndex !== null && pitchHand.pointsWon !== undefined && (
                <button onClick={() => {
                  const made = pitchHand.isMoon ? pitchHand.pointsWon === pointSys.total : pitchHand.pointsWon >= pitchHand.bidAmount;
                  const isMoon = pitchHand.isMoon;
                  const pointsWon = pitchHand.pointsWon;
                  const otherPoints = pointSys.total - pointsWon;
                  
                  let newPlayers = [...players];
                  
                  if (pitchConfig.gameMode === 'teams') {
                    // Teams: player 0 holds team 1 score, player 1 holds team 2 score
                    const bidderTeam1 = pitchHand.bidderIndex === 0 || pitchHand.bidderIndex === 2;
                    const bidderScoreIdx = bidderTeam1 ? 0 : 1;
                    const otherScoreIdx = bidderTeam1 ? 1 : 0;
                    
                    if (isMoon) {
                      if (made) {
                        if (pitchConfig.moonReward === 'double') {
                          newPlayers[bidderScoreIdx] = {...newPlayers[bidderScoreIdx], total: newPlayers[bidderScoreIdx].total + pointsWon * 2};
                        } else if (pitchConfig.moonReward === 'fixed') {
                          newPlayers[bidderScoreIdx] = {...newPlayers[bidderScoreIdx], total: newPlayers[bidderScoreIdx].total + pitchConfig.moonRewardValue};
                        } else if (pitchConfig.moonReward === 'goTo') {
                          newPlayers[bidderScoreIdx] = {...newPlayers[bidderScoreIdx], total: newPlayers[bidderScoreIdx].total < 0 ? 0 : pitchConfig.moonRewardValue};
                        } else if (pitchConfig.moonReward === 'autoWin') {
                          newPlayers[bidderScoreIdx] = {...newPlayers[bidderScoreIdx], total: newPlayers[bidderScoreIdx].total >= 0 ? effectiveTarget : 0};
                        }
                      } else {
                        // Moon missed
                        if (pitchConfig.moonPenalty === 'set') {
                          newPlayers[bidderScoreIdx] = {...newPlayers[bidderScoreIdx], total: newPlayers[bidderScoreIdx].total - pointSys.total};
                        } else if (pitchConfig.moonPenalty === 'fixed') {
                          newPlayers[bidderScoreIdx] = {...newPlayers[bidderScoreIdx], total: newPlayers[bidderScoreIdx].total - pitchConfig.moonPenaltyValue};
                        } else if (pitchConfig.moonPenalty === 'zero') {
                          newPlayers[bidderScoreIdx] = {...newPlayers[bidderScoreIdx], total: 0};
                        }
                        newPlayers[otherScoreIdx] = {...newPlayers[otherScoreIdx], total: newPlayers[otherScoreIdx].total + otherPoints};
                      }
                    } else {
                      // Normal bid
                      if (made) {
                        newPlayers[bidderScoreIdx] = {...newPlayers[bidderScoreIdx], total: newPlayers[bidderScoreIdx].total + pointsWon};
                      } else {
                        newPlayers[bidderScoreIdx] = {...newPlayers[bidderScoreIdx], total: newPlayers[bidderScoreIdx].total - pitchHand.bidAmount};
                      }
                      newPlayers[otherScoreIdx] = {...newPlayers[otherScoreIdx], total: newPlayers[otherScoreIdx].total + otherPoints};
                    }
                  } else if (pitchConfig.gameMode === 'callPartner') {
                    const bidderIdx = pitchHand.bidderIndex;
                    const partnerIdx = pitchHand.partnerIndex;
                    const bidderTeamIndices = partnerIdx === -1 ? [bidderIdx] : [bidderIdx, partnerIdx];
                    const otherIndices = players.map((_, i) => i).filter(i => !bidderTeamIndices.includes(i));
                    
                    if (isMoon) {
                      if (made) {
                        if (pitchConfig.moonReward === 'double') {
                          bidderTeamIndices.forEach(i => { newPlayers[i] = {...newPlayers[i], total: newPlayers[i].total + pointsWon * 2}; });
                        } else if (pitchConfig.moonReward === 'fixed') {
                          bidderTeamIndices.forEach(i => { newPlayers[i] = {...newPlayers[i], total: newPlayers[i].total + pitchConfig.moonRewardValue}; });
                        } else if (pitchConfig.moonReward === 'goTo') {
                          bidderTeamIndices.forEach(i => { newPlayers[i] = {...newPlayers[i], total: newPlayers[i].total < 0 ? 0 : pitchConfig.moonRewardValue}; });
                        } else if (pitchConfig.moonReward === 'autoWin') {
                          newPlayers[bidderIdx] = {...newPlayers[bidderIdx], total: newPlayers[bidderIdx].total >= 0 ? effectiveTarget : 0};
                        }
                      } else {
                        if (pitchConfig.moonPenalty === 'set') {
                          bidderTeamIndices.forEach(i => { newPlayers[i] = {...newPlayers[i], total: newPlayers[i].total - pointSys.total}; });
                        } else if (pitchConfig.moonPenalty === 'fixed') {
                          bidderTeamIndices.forEach(i => { newPlayers[i] = {...newPlayers[i], total: newPlayers[i].total - pitchConfig.moonPenaltyValue}; });
                        } else if (pitchConfig.moonPenalty === 'zero') {
                          bidderTeamIndices.forEach(i => { newPlayers[i] = {...newPlayers[i], total: 0}; });
                        }
                        const perPlayer = Math.floor(otherPoints / otherIndices.length);
                        otherIndices.forEach(i => { newPlayers[i] = {...newPlayers[i], total: newPlayers[i].total + perPlayer}; });
                      }
                    } else {
                      if (made) {
                        bidderTeamIndices.forEach(i => { newPlayers[i] = {...newPlayers[i], total: newPlayers[i].total + pointsWon}; });
                      } else {
                        bidderTeamIndices.forEach(i => { newPlayers[i] = {...newPlayers[i], total: newPlayers[i].total - pitchHand.bidAmount}; });
                      }
                      const perPlayer = Math.floor(otherPoints / otherIndices.length);
                      otherIndices.forEach(i => { newPlayers[i] = {...newPlayers[i], total: newPlayers[i].total + perPlayer}; });
                    }
                  } else {
                    // Cutthroat
                    const bidderIdx = pitchHand.bidderIndex;
                    if (isMoon) {
                      if (made) {
                        if (pitchConfig.moonReward === 'double') {
                          newPlayers[bidderIdx] = {...newPlayers[bidderIdx], total: newPlayers[bidderIdx].total + pointsWon * 2};
                        } else if (pitchConfig.moonReward === 'fixed') {
                          newPlayers[bidderIdx] = {...newPlayers[bidderIdx], total: newPlayers[bidderIdx].total + pitchConfig.moonRewardValue};
                        } else if (pitchConfig.moonReward === 'goTo') {
                          newPlayers[bidderIdx] = {...newPlayers[bidderIdx], total: newPlayers[bidderIdx].total < 0 ? 0 : pitchConfig.moonRewardValue};
                        } else if (pitchConfig.moonReward === 'autoWin') {
                          newPlayers[bidderIdx] = {...newPlayers[bidderIdx], total: newPlayers[bidderIdx].total >= 0 ? effectiveTarget : 0};
                        }
                      } else {
                        if (pitchConfig.moonPenalty === 'set') {
                          newPlayers[bidderIdx] = {...newPlayers[bidderIdx], total: newPlayers[bidderIdx].total - pointSys.total};
                        } else if (pitchConfig.moonPenalty === 'fixed') {
                          newPlayers[bidderIdx] = {...newPlayers[bidderIdx], total: newPlayers[bidderIdx].total - pitchConfig.moonPenaltyValue};
                        } else if (pitchConfig.moonPenalty === 'zero') {
                          newPlayers[bidderIdx] = {...newPlayers[bidderIdx], total: 0};
                        }
                      }
                    } else {
                      if (made) {
                        newPlayers[bidderIdx] = {...newPlayers[bidderIdx], total: newPlayers[bidderIdx].total + pointsWon};
                      } else {
                        newPlayers[bidderIdx] = {...newPlayers[bidderIdx], total: newPlayers[bidderIdx].total - pitchHand.bidAmount};
                      }
                    }
                  }
                  
                  setPlayers(newPlayers);
                  setPitchHand({
                    dealerIndex: (pitchHand.dealerIndex + 1) % players.length,
                    bidderIndex: null,
                    bidAmount: 0,
                    isMoon: false,
                    calledCard: '',
                    partnerIndex: null,
                    pointsWon: undefined
                  });
                  setCurrentRound(currentRound + 1);
                  
                  // Check for winner
                  const maxScore = Math.max(...newPlayers.map(p => p.total));
                  if (maxScore >= effectiveTarget) {
                    const winnerPlayer = newPlayers.find(p => p.total >= effectiveTarget);
                    setWinner(winnerPlayer);
                    setScreen('winner');
                  }
                }}
                style={{width: '100%', padding: '14px', borderRadius: '12px', border: 'none', cursor: 'pointer',
                  background: '#7c3aed', color: 'white', fontWeight: '600', fontSize: '16px'}}>
                Record Hand
              </button>
              )}
            </div>
          </div>
        );
      };
      // STANDARD GAME
      const StandardGame = () => (
        <div>
          <div className="card">
            <div className="flex justify-between items-center mb-3">
              <h3 className="text-white font-semibold">Standings</h3>
              {game.targetScore && <span className="text-light text-sm">First to {game.targetScore}</span>}
            </div>
            {sortedPlayers.map((player, index) => (
              <div key={player.id} className={`standing-item ${index === 0 && player.total > 0 ? 'leader' : ''}`}>
                <div className="flex items-center justify-between mb-1">
                  <div className="flex items-center gap-3">
                    <span className={`rank ${index === 0 && player.total > 0 ? 'leader' : ''}`}>{index + 1}</span>
                    <span className="text-white font-medium">{player.name}</span>
                  </div>
                  <span className="text-white text-xl font-bold">{player.total}</span>
                </div>
                {game.targetScore && <div className="progress-bar" style={{marginLeft: '36px'}}><div className="progress-fill" style={{width: `${Math.min((player.total / game.targetScore) * 100, 100)}%`}}></div></div>}
              </div>
            ))}
          </div>
          <div className="card">
            <h3 className="text-white font-semibold mb-3">Round {currentRound} - Enter Scores</h3>
            {players.map(player => (
              <div key={player.id} className="score-entry">
                <span className="score-entry-name">{player.name}</span>
                <button onClick={() => setEditingRoundScore({playerId: player.id, value: roundScores[player.id] || ''})} 
                  className="input input-score" style={{cursor: 'pointer', minWidth: '80px'}}>
                  {roundScores[player.id] || 'Ã¢â‚¬â€'}
                </button>
              </div>
            ))}
            <button onClick={submitRound} disabled={!players.every(p => roundScores[p.id] !== '' && roundScores[p.id] !== '-')} className={`btn accent-${game.color} text-white w-full mt-2`}>Submit Round</button>
          </div>
          {players[0]?.scores.length > 0 && (
            <div className="card">
              <h3 className="text-white font-semibold mb-3">History <span className="text-light text-xs font-normal">(tap to edit)</span></h3>
              <div className="overflow-x">
                <table className="history-table">
                  <thead><tr><th className="text-left">Player</th>{players[0].scores.map((_, i) => <th key={i} className="text-center">R{i + 1}</th>)}</tr></thead>
                  <tbody>{players.map(player => (
                    <tr key={player.id}><td>{player.name}</td>{player.scores.map((score, i) => (
                      <td key={i} className="text-center"><span className={`editable ${score === 0 ? 'zero' : ''}`} onClick={() => startEditScore(player.id, i, score)}>{score}</span></td>
                    ))}</tr>
                  ))}</tbody>
                </table>
              </div>
            </div>
          )}
        </div>
      );

      // RENDER
      if (screen === 'home') return (
        <div className="app bg-slate">
          <div className="container">
            {/* Auth Header */}
            {firebaseConfigured && (
              <div style={{display: 'flex', justifyContent: 'flex-end', paddingTop: '16px', paddingBottom: '8px'}}>
                {authLoading ? (
                  <div style={{color: 'rgba(255,255,255,0.5)', fontSize: '14px'}}>Loading...</div>
                ) : currentUser ? (
                  <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                    <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                      {currentUser.photoURL && (
                        <img src={currentUser.photoURL} alt="Profile" style={{width: '32px', height: '32px', borderRadius: '50%', border: '2px solid rgba(255,255,255,0.3)'}} />
                      )}
                      <span style={{color: 'white', fontSize: '14px', fontWeight: '500'}}>{currentUser.displayName}</span>
                    </div>
                    <button onClick={handleSignOut} style={{background: 'rgba(255,255,255,0.2)', border: 'none', borderRadius: '8px', padding: '6px 12px', color: 'white', fontSize: '13px', cursor: 'pointer', fontWeight: '500'}}>Sign Out</button>
                  </div>
                ) : (
                  <button onClick={handleSignIn} style={{background: 'rgba(255,255,255,0.2)', border: 'none', borderRadius: '8px', padding: '8px 16px', color: 'white', fontSize: '14px', cursor: 'pointer', fontWeight: '500', display: 'flex', alignItems: 'center', gap: '8px'}}>
                    <span>ðŸ”</span> Sign In with Google
                  </button>
                )}
              </div>
            )}

            {/* Group Selector */}
            {firebaseConfigured && currentUser && (
              <div className="mb-4">
                <select
                  value={selectedGroupId || ''}
                  onChange={(e) => switchToGroup(e.target.value)}
                  className="input group-selector w-full"
                  style={{fontSize: '14px', padding: '10px 12px'}}
                >
                  <option value="">No Group Selected</option>
                  {currentGroups.map(group => (
                    <option key={group.id} value={group.id}>
                      {group.name} ({group.memberCount} {group.memberCount === 1 ? 'member' : 'members'})
                    </option>
                  ))}
                </select>
              </div>
            )}

            <div className="text-center mb-8 pt-8">
              <h1 className="text-4xl font-bold text-white mb-2"><img src="./icon-192.png" alt="" style={{width: '40px', height: '40px', display: 'inline-block', verticalAlign: 'middle', marginRight: '8px', borderRadius: '8px'}} />Game Night</h1>
              <p className="text-light mb-1">Score Keeper</p>
              <p className="text-xs" style={{color: '#22c55e'}}>presented by <span className="font-semibold">Baldwin Ag</span></p>
              <p className="text-xs mt-2" style={{color: 'rgba(255,255,255,0.4)'}}>v{APP_VERSION}</p>
              {currentUser && (
                <p className="text-xs mt-2" style={{color: '#22c55e'}}>â˜ï¸ Signed in - Ready for cloud sync</p>
              )}
            </div>

            {/* Manage Groups Button */}
            {firebaseConfigured && currentUser && (
              <button onClick={() => setShowGroupManager(true)} className="w-full mb-4" style={{background: 'linear-gradient(135deg, #581c87 0%, #7c3aed 100%)', border: 'none', borderRadius: '16px', padding: '16px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'space-between'}}>
                <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                  <span style={{fontSize: '32px'}}>ðŸ‘¥</span>
                  <div style={{textAlign: 'left'}}>
                    <div style={{color: 'white', fontSize: '18px', fontWeight: 'bold'}}>Manage Groups</div>
                    <div style={{color: 'rgba(255,255,255,0.8)', fontSize: '13px'}}>Create, join, and switch groups</div>
                  </div>
                </div>
                <span style={{color: 'rgba(255,255,255,0.5)', fontSize: '24px'}}>â†’</span>
              </button>
            )}

            <button onClick={() => setShowLeaderboard(true)} className="w-full mb-6" style={{background: 'linear-gradient(135deg, #78350f 0%, #d97706 100%)', border: 'none', borderRadius: '16px', padding: '16px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'space-between'}}>
              <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                <span style={{fontSize: '32px'}}>ðŸ†</span>
                <div style={{textAlign: 'left'}}>
                  <h2 className="text-xl font-bold text-white">Wins Leaderboard</h2>
                  <p className="text-sm" style={{color: 'rgba(255,255,255,0.8)'}}>See who's winning the most</p>
                </div>
              </div>
              <span style={{color: 'white', fontSize: '24px'}}>â†’</span>
            </button>
            <div className="game-cards-grid">
              {Object.entries(GAMES).map(([key, g]) => (
                <div key={key} className={`game-card bg-${g.color}`}>
                  <button onClick={() => selectGame(key)} className="game-card-btn">
                    <span className="game-icon">{g.icon}</span>
                    <div><h2 className="text-xl font-bold text-white">{g.name}</h2><p className="text-lighter text-sm">{g.description}</p></div>
                  </button>
                  <button onClick={() => { setSelectedGame(key); setShowRules(true); }} className="rules-btn">Ã°Å¸â€œâ€“</button>
                </div>
              ))}
            </div>
            <p className="text-center text-light text-sm mt-8">Ã°Å¸â€œÂ± Add to home screen for offline use!</p>
            {firebaseConfigured && !currentUser && !authLoading && (
              <p className="text-center text-xs mt-2" style={{color: '#22c55e'}}>â˜ï¸ Sign in to unlock player groups and cloud sync</p>
            )}
            <p className="text-center text-xs mt-4" style={{color: 'rgba(255,255,255,0.4)', lineHeight: '1.4'}}>
              YahtzeeÃ‚Â® is a trademark of Hasbro. Phase 10Ã‚Â® is a trademark of Mattel.<br/>
              This app is not affiliated with or endorsed by any game manufacturers.
            </p>
          </div>
        </div>
      );

      if (screen === 'players') return (
        <div className={`app bg-${game.color}`} style={{paddingBottom: '24px'}}>
          <div className="container">
            <div className="flex justify-between items-center mb-4">
              <button onClick={confirmGoHome} className="text-white" style={{background: 'rgba(255,255,255,0.2)', padding: '8px 16px', borderRadius: '8px', border: 'none', cursor: 'pointer'}}>â†Â Back</button>
              <button onClick={() => setShowRules(true)} className="rules-btn">Ã°Å¸â€œâ€“ Rules</button>
            </div>
            <div className="text-center mb-6">
              <span className="text-5xl mb-2">{game.icon}</span>
              <h1 className="text-3xl font-bold text-white mb-1">{game.name}</h1>
              <p className="text-lighter">{game.description}</p>
            </div>
            
            {/* Saved Players */}
            {savedPlayersList.length > 0 && (
              <div className="card mb-4">
                <h2 className="text-lg font-semibold text-white mb-3">Ã°Å¸â€˜Â¥ Saved Players</h2>
                <div style={{display: 'flex', flexWrap: 'wrap', gap: '8px'}}>
                  {savedPlayersList.map(name => {
                    const inGame = players.find(p => p.name === name);
                    return (
                      <button key={name} onClick={() => !inGame && addSavedPlayer(name)}
                        style={{
                          padding: '8px 14px', borderRadius: '20px', border: 'none', cursor: inGame ? 'default' : 'pointer',
                          background: inGame ? 'rgba(34,197,94,0.3)' : 'rgba(255,255,255,0.2)',
                          color: inGame ? '#86efac' : 'white', fontSize: '14px', fontWeight: '500',
                          display: 'flex', alignItems: 'center', gap: '6px'
                        }}>
                        {inGame && <span>âœ‹â€œ</span>}
                        {name}
                      </button>
                    );
                  })}
                </div>
                <p className="text-light text-xs mt-3" style={{opacity: 0.7}}>Tap to add to game</p>
              </div>
            )}
            
            {/* Add New Player */}
            <div className="card">
              <h2 className="text-lg font-semibold text-white mb-3">âž• Add Player</h2>
              <div className="flex gap-2 mb-3">
                <input type="text" value={newPlayerName} onChange={(e) => setNewPlayerName(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && addPlayer()} placeholder="Enter name" className="input flex-1" maxLength={15} />
                <button onClick={addPlayer} disabled={!newPlayerName.trim() || players.length >= game.maxPlayers} className={`btn accent-${game.color} text-white`}>Add</button>
              </div>
              <label style={{display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer'}}>
                <input type="checkbox" checked={saveNewPlayer} onChange={(e) => setSaveNewPlayer(e.target.checked)} 
                  style={{width: '18px', height: '18px', accentColor: '#22c55e'}} />
                <span className="text-light text-sm">Save to memory for future games</span>
              </label>
            </div>
            
            {/* Current Players */}
            <div className="card mt-4">
              <h2 className="text-lg font-semibold text-white mb-3">ðŸŽ® Playing This Game</h2>
              {players.length === 0 ? (
                <p className="text-light text-center" style={{opacity: 0.7}}>No players added yet</p>
              ) : (
                players.map((player, i) => (
                  <div key={player.id} className="player-item">
                    <span className="text-white"><span className="text-light mr-2">{i + 1}.</span>{player.name}</span>
                    <button onClick={() => removePlayer(player.id)} className="remove-btn">âœ‹â€¢</button>
                  </div>
                ))
              )}
              <p className="text-lighter text-sm mt-3 text-center">{players.length < game.minPlayers ? `Add at least ${game.minPlayers} players` : `${players.length}/${game.maxPlayers} players`}</p>
            </div>
            
            {players.length >= game.minPlayers && <button onClick={startGame} className={`btn accent-${game.color} text-white w-full text-lg mt-4`} style={{padding: '16px'}}>Start Game</button>}
            
            {/* Manage saved players */}
            {savedPlayersList.length > 0 && (
              <details style={{marginTop: '16px'}}>
                <summary className="text-light text-sm" style={{cursor: 'pointer', opacity: 0.7}}>Manage saved players...</summary>
                <div className="card mt-2">
                  {savedPlayersList.map(name => (
                    <div key={name} className="player-item" style={{marginBottom: '4px'}}>
                      <span className="text-white">{name}</span>
                      <button onClick={() => removeSavedPlayer(name)} className="remove-btn" title="Remove from saved">Ã°Å¸â€”â€˜Ã¯Â¸Â</button>
                    </div>
                  ))}
                </div>
              </details>
            )}
          </div>
        </div>
      );

      if (screen === 'winner') return (
        <div className="app bg-amber flex items-center justify-center">
          <div className="container text-center">
            <div className="text-6xl mb-4">ðŸ†</div>
            <h1 className="text-4xl font-bold text-white mb-2">{winner.name} Wins!</h1>
            <p className="text-amber text-xl mb-2">{selectedGame === 'phase10' ? `All phases with ${winner.total} penalty` : `${winner.total.toLocaleString()} points`}</p>
            <p className="text-light mb-2">{game.name}</p>
            <p className="text-xs mb-6" style={{color: 'rgba(255,255,255,0.6)'}}>âœ“ Win recorded to leaderboard</p>
            <div className="card mb-6">
              <h2 className="text-lg font-semibold text-white mb-3">Final Standings</h2>
              {sortedPlayers.map((player, i) => (
                <div key={player.id} className={`standing-item ${i === 0 ? 'leader' : ''}`}>
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3"><span className={`rank ${i === 0 ? 'leader' : 'text-amber'}`}>{i + 1}</span><span className="text-white font-medium">{player.name}</span></div>
                    <span className="text-white text-xl font-bold">{player.total.toLocaleString()}</span>
                  </div>
                </div>
              ))}
            </div>
            <div className="flex gap-3">
              <button onClick={() => setShowResetConfirm(true)} className="btn btn-primary flex-1">Play Again</button>
              <button onClick={confirmGoHome} className="btn btn-primary flex-1">Home</button>
            </div>
          </div>
          {showResetConfirm && <ResetConfirmModal />}
          {showHomeConfirm && <HomeConfirmModal />}
        </div>
      );

      const renderGameContent = () => {
        if (selectedGame === 'yahtzee') return activeTab === 'scorecard' ? <YahtzeeScorecard /> : <YahtzeeReference />;
        if (selectedGame === 'phase10') return activeTab === 'scorecard' ? <Phase10Scorecard /> : <Phase10Reference />;
        if (selectedGame === 'farkle') return activeTab === 'scorecard' ? <FarkleScorecard /> : <FarkleReference />;
        if (selectedGame === 'cribbage') return activeTab === 'scorecard' ? <CribbageBoard /> : <CribbageReference />;
        if (selectedGame === 'pitch') return activeTab === 'scorecard' ? <PitchGame /> : <PitchReference />;
        return <StandardGame />;
      };

      return (
        <div className={`app bg-${game.color} pb-24`}>
          <div className="container">
            <div className="flex items-center justify-between mb-4 pt-4">
              <div className="flex items-center gap-2"><span className="text-2xl">{game.icon}</span><h1 className="text-2xl font-bold text-white">{game.name}</h1></div>
              <div className="flex items-center gap-2">
                <button onClick={() => setShowRules(true)} className="rules-btn">Ã°Å¸â€œâ€“</button>
                <span className="badge">Rd {currentRound}</span>
              </div>
            </div>
            {game.hasTabs && (
              <div className="tabs">
                <button onClick={() => setActiveTab('scorecard')} className={`tab ${activeTab === 'scorecard' ? 'active' : ''}`}>{game.tabLabels.scorecard}</button>
                <button onClick={() => setActiveTab('reference')} className={`tab ${activeTab === 'reference' ? 'active' : ''}`}>{game.tabLabels.reference}</button>
              </div>
            )}
            {renderGameContent()}
          </div>
          <div className="bottom-bar">
            <div className="container">
              <button onClick={() => setShowResetConfirm(true)} className="btn btn-primary flex-1">Reset</button>
              <button onClick={goHome} className="btn btn-primary flex-1">Home</button>
            </div>
          </div>
          {showResetConfirm && <ResetConfirmModal />}
          {showHomeConfirm && <HomeConfirmModal />}
          {editingScore && <EditScoreModal />}
          {editingYahtzee && <EditYahtzeeModal />}
          {editingCribbage && <EditCribbageModal />}
          {editingPitch && <EditPitchModal />}
          {editingRoundScore && <RoundScoreModal />}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
